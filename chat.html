<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶∞‡ßÅ‡¶Æ</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin:0; display:flex; flex-direction:column; height:100vh;
      background: #f9fafb;
    }
    header {
      background:#2563eb; color:#fff; padding:15px;
      font-weight:bold; display:flex; justify-content:space-between;
      align-items:center;
      user-select:none;
    }
    #logoutBtn {
      background:#ef4444; border:none; color:#fff;
      padding:8px 15px; border-radius:5px; cursor:pointer;
      font-weight:bold;
      transition: background-color 0.3s ease;
    }
    #logoutBtn:hover {
      background:#b91c1c;
    }
    #messages {
      flex:1; overflow-y:auto; padding:15px;
      background:#fff;
      border-top: 1px solid #ddd;
      border-bottom: 1px solid #ddd;
    }
    .message {
      background:#f3f4f6; padding:10px; margin-bottom:10px;
      border-radius:8px; box-shadow: 0 1px 3px rgb(0 0 0 / 0.1);
      position: relative;
      max-width: 80%;
      word-wrap: break-word;
    }
    .message.you {
      margin-left:auto; background:#dbeafe;
    }
    .sender {
      font-weight:bold; margin-bottom:5px;
      font-size:14px; color:#2563eb;
    }
    .text {
      font-size:16px;
      white-space: pre-wrap;
    }
    .replyBox {
      font-size: 13px;
      color: #555;
      background: #e0e7ff;
      padding: 6px 10px;
      border-left: 4px solid #2563eb;
      margin-bottom: 5px;
      border-radius: 5px;
      font-style: italic;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .message img {
      max-width: 180px;
      border-radius: 8px;
      margin-top: 5px;
      cursor: pointer;
      display: block;
    }
    .actions {
      position: absolute;
      top: 5px;
      right: 10px;
      font-size: 14px;
      display: flex;
      gap: 10px;
    }
    .actions button {
      background: transparent;
      border: none;
      cursor: pointer;
      color: #888;
      font-weight: bold;
      transition: color 0.3s ease;
    }
    .actions button:hover {
      color: #2563eb;
    }
    #inputBox {
      display:flex; padding:10px; background:#f3f4f6;
      gap: 8px; align-items:center;
    }
    #messageInput {
      flex:1; padding:12px; border-radius:5px; border:1px solid #ccc;
      font-size:16px;
      resize: none;
      height: 50px;
    }
    #sendBtn, #imageBtn, #replyCancelBtn {
      background:#2563eb; color:#fff; border:none;
      padding:10px 15px; border-radius:5px; cursor:pointer;
      font-weight:bold;
      flex-shrink: 0;
    }
    #replyCancelBtn {
      background:#ef4444;
    }
    #replyInfo {
      background:#e0e7ff; padding:8px 12px; border-radius:5px;
      margin: 8px 15px 0 15px; font-size:14px;
      display:none;
      position: relative;
      font-style: italic;
    }
    #replyInfo button {
      position:absolute;
      top: 4px; right: 6px;
      background: transparent; border:none;
      font-weight:bold; cursor:pointer; color:#2563eb;
      font-size: 18px;
      line-height: 1;
    }
  </style>
</head>
<body>

<header>
  ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü - <span id="userName"></span>
  <button id="logoutBtn">‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</button>
</header>

<div id="messages"></div>

<div id="replyInfo">
  ‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶ï‡¶∞‡¶õ‡¶ø: <span id="replyText"></span>
  <button id="replyCancelBtn" title="‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡ßã">√ó</button>
</div>

<div id="inputBox">
  <textarea id="messageInput" placeholder="‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." rows="1"></textarea>
  <input type="file" id="imageInput" accept="image/*" style="display:none" />
  <button id="imageBtn" title="‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßã">üñºÔ∏è</button>
  <button id="sendBtn" title="‡¶™‡¶æ‡¶†‡¶æ‡¶ì">‚û§</button>
</div>

<script type="module">
  import { db, storage } from './firebase-config.js';
  import {
    collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, deleteDoc, getDoc
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
  import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

  const userId = localStorage.getItem('userId');
  const userName = localStorage.getItem('userName');

  if (!userId || !userName) {
    alert('‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
    window.location.href = 'index.html';
  }

  document.getElementById('userName').textContent = userName;

  const messagesDiv = document.getElementById('messages');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const imageBtn = document.getElementById('imageBtn');
  const imageInput = document.getElementById('imageInput');
  const logoutBtn = document.getElementById('logoutBtn');
  const replyInfo = document.getElementById('replyInfo');
  const replyTextSpan = document.getElementById('replyText');
  const replyCancelBtn = document.getElementById('replyCancelBtn');

  let replyTo = null;

  // ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
  logoutBtn.onclick = () => {
    localStorage.clear();
    window.location.href = 'index.html';
  };

  // ‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤
  replyCancelBtn.onclick = () => {
    replyTo = null;
    replyInfo.style.display = 'none';
  };

  // ‡¶á‡¶Æ‡ßá‡¶ú ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶≤‡ßá ‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶π‡¶¨‡ßá
  imageBtn.onclick = () => {
    imageInput.click();
  };

  // ‡¶á‡¶Æ‡ßá‡¶ú ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶π‡¶≤‡ßá ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßã
  imageInput.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const storageRef = ref(storage, `chatImages/${Date.now()}_${file.name}`);
    try {
      const snapshot = await uploadBytes(storageRef, file);
      const url = await getDownloadURL(snapshot.ref);
      await sendMessage('', url);
      imageInput.value = '';
    } catch (err) {
      alert('‡¶á‡¶Æ‡ßá‡¶ú ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§');
      console.error(err);
    }
  };

  // ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
  async function sendMessage(text, imageUrl = '') {
    if (!text && !imageUrl) return;

    try {
      await addDoc(collection(db, 'messages'), {
        sender: userId,
        senderName: userName,
        text,
        imageUrl,
        timestamp: serverTimestamp(),
        replyTo,
      });
      messageInput.value = '';
      replyTo = null;
      replyInfo.style.display = 'none';
      messageInput.style.height = '50px';
    } catch (err) {
      alert('‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶™‡¶æ‡¶†‡¶æ‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§');
      console.error(err);
    }
  }

  sendBtn.onclick = () => {
    sendMessage(messageInput.value.trim());
  };

  // Enter ‡¶™‡ßç‡¶∞‡ßá‡¶∏ ‡¶ï‡¶∞‡¶≤‡ßá ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶Ø‡¶æ‡¶¨‡ßá, Shift+Enter ‡¶¶‡¶ø‡¶≤‡ßá ‡¶®‡¶§‡ßÅ‡¶® ‡¶≤‡¶æ‡¶á‡¶® ‡¶π‡¶¨‡ßá
  messageInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage(messageInput.value.trim());
    }
  });

  // ‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶≤‡¶ü‡¶æ‡¶á‡¶Æ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶≤‡ßã‡¶°‡¶ø‡¶Ç
  const messagesQuery = query(collection(db, 'messages'), orderBy('timestamp', 'asc'));
  onSnapshot(messagesQuery, async (snapshot) => {
    messagesDiv.innerHTML = '';
    for (const docSnap of snapshot.docs) {
      const msg = docSnap.data();
      const id = docSnap.id;

      const msgDiv = document.createElement('div');
      msgDiv.classList.add('message');
      if (msg.sender === userId) msgDiv.classList.add('you');

      // sender name
      const senderDiv = document.createElement('div');
      senderDiv.classList.add('sender');
      senderDiv.textContent = msg.senderName || 'Unknown';
      msgDiv.appendChild(senderDiv);

      // reply info ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã (‡¶Ø‡¶¶‡¶ø ‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶•‡¶æ‡¶ï‡ßá)
      if (msg.replyTo) {
        try {
          const replyDocRef = doc(db, 'messages', msg.replyTo);
          const replyDocSnap = await getDoc(replyDocRef);
          if (replyDocSnap.exists()) {
            const replyData = replyDocSnap.data();
            const replyBox = document.createElement('div');
            replyBox.classList.add('replyBox');
            const replyTextPreview = replyData.text ? replyData.text.slice(0, 50) : '[‡¶õ‡¶¨‡¶ø]';
            replyBox.textContent = `‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á: ${replyTextPreview}`;
            msgDiv.appendChild(replyBox);
          }
        } catch (error) {
          console.error('‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ:', error);
        }
      }

      // ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú‡ßá‡¶∞ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü
      if (msg.text) {
        const textDiv = document.createElement('div');
        textDiv.classList.add('text');
        textDiv.textContent = msg.text;
        msgDiv.appendChild(textDiv);
      }

      // ‡¶á‡¶Æ‡ßá‡¶ú ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã
      if (msg.imageUrl) {
        const img = document.createElement('img');
        img.src = msg.imageUrl;
        img.alt = "Image";
        // ‡¶¨‡ßú ‡¶õ‡¶¨‡¶ø ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶≤‡ßá ‡¶®‡¶§‡ßÅ‡¶® ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨‡ßá ‡¶ñ‡ßÅ‡¶≤‡¶¨‡ßá
        img.onclick = () => window.open(msg.imageUrl, '_blank');
        msgDiv.appendChild(img);
      }

      // ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶è‡¶ï‡¶∂‡¶®‡ßá ‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶ì ‡¶°‡¶ø‡¶≤‡ßá‡¶ü ‡¶¨‡¶æ‡¶ü‡¶®
      const actionsDiv = document.createElement('div');
      actionsDiv.classList.add('actions');

      // ‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶¨‡¶æ‡¶ü‡¶®
      const replyBtn = document.createElement('button');
      replyBtn.textContent = '‚Ü©Ô∏è';
      replyBtn.title = '‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶ï‡¶∞‡ßã';
      replyBtn.onclick = () => {
        replyTo = id;
        replyInfo.style.display = 'block';
        replyTextSpan.textContent = msg.text || '[‡¶õ‡¶¨‡¶ø]';
        messageInput.focus();
      };
      actionsDiv.appendChild(replyBtn);

      // ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶Ø‡¶ø‡¶®‡¶ø ‡¶™‡¶æ‡¶†‡¶ø‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡¶®, ‡¶§‡¶æ‡¶∞‡¶æ‡¶á ‡¶°‡¶ø‡¶≤‡ßá‡¶ü ‡¶¨‡¶æ‡¶ü‡¶® ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶¨‡ßá
      if (msg.sender === userId) {
        const delBtn = document.createElement('button');
        delBtn.textContent = 'üóëÔ∏è';
        delBtn.title = '‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶°‡¶ø‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡ßã';
        delBtn.onclick = async () => {
          if (confirm('‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶ï‡¶ø ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶ì?')) {
            try {
              await deleteDoc(doc(db, 'messages', id));
              alert('‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
            } catch (err) {
              alert('‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
              console.error(err);
            }
          }
        };
        actionsDiv.appendChild(delBtn);
      }

      msgDiv.appendChild(actionsDiv);
      messagesDiv.appendChild(msgDiv);
    }

    // ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶≤ ‡¶°‡¶ø‡¶≠‡ßá‡¶∞ ‡¶∂‡ßá‡¶∑‡ßá ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶≤ ‡¶ï‡¶∞‡ßá ‡¶®‡¶ø‡¶ö‡ßá ‡¶®‡¶ø‡ßü‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
</script>

</body>
</html>
