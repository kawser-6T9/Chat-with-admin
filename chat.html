<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pakhi Chat</title>
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --blue:#2563eb;
    --blue-600:#1e40af;
    --self-bg: linear-gradient(135deg,#2d8df7,#1f6fe0);
    --other-bg: linear-gradient(180deg,#ffffff,#f3f4f6);
  }
  *{box-sizing:border-box}
  body,html{height:100%;margin:0;font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  body{
    background: #e6eefc url('https://www.transparenttextures.com/patterns/asfalt-light.png');
    display:flex;flex-direction:column;
  }

  header{
    background:var(--blue);
    color:white;
    padding:14px 18px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    box-shadow:0 4px 12px rgba(37,99,235,0.15);
    user-select:none;
  }
  header .title{font-weight:700;font-size:18px}
  header .me{font-size:14px;opacity:0.9}

  /* chat area */
  #chatWrap{flex:1;display:flex;flex-direction:column;min-height:0} /* min-height:0 for flexbox scroll */
  #messages{
    padding:14px;
    overflow-y:auto;
    display:flex;
    flex-direction:column;
    gap:12px;
    -webkit-overflow-scrolling:touch;
  }

  /* message card */
  .message{
    display:flex;
    gap:10px;
    max-width:78%;
    padding:10px;
    border-radius:14px;
    align-items:flex-start;
    box-shadow:0 6px 18px rgba(16,24,40,0.06);
    transform-origin: bottom;
    animation: appear 280ms cubic-bezier(.2,.9,.3,1);
    position:relative;
    word-break:break-word;
  }
  @keyframes appear{
    from{opacity:0;transform:translateY(8px) scale(.995)}
    to{opacity:1;transform:translateY(0) scale(1)}
  }

  .message.you{ margin-left:auto; background:var(--self-bg); color:white; border-bottom-right-radius:6px; }
  .message.other{ margin-right:auto; background:var(--other-bg); color:#0f172a; border-bottom-left-radius:6px; }

  /* profile initial */
  .avatar{
    width:40px;height:40px;border-radius:50%;
    display:flex;align-items:center;justify-content:center;font-weight:700;color:white;
    flex-shrink:0;font-size:16px;
  }
  .avatar.self{ background:linear-gradient(135deg,#60a5fa,#2563eb); }
  .avatar.other{ background:linear-gradient(135deg,#94a3b8,#64748b); }

  .msgBody{display:flex;flex-direction:column;gap:6px;min-width:0}
  .senderName{font-weight:700;font-size:13px;opacity:.95}
  .text{font-size:15px;line-height:1.35;white-space:pre-wrap}
  .msg-img{max-width:320px;border-radius:10px;display:block;cursor:pointer;margin-top:6px}
  .time{font-size:11px;color:rgba(15,23,42,0.55);align-self:flex-end;margin-top:6px}

  /* small "deleted" style */
  .deleted{font-style:italic;color:rgba(15,23,42,0.6);opacity:0.85}

  /* popup menu (Reply/Delete) */
  .msg-menu{
    position:absolute;
    background:white;
    box-shadow:0 8px 20px rgba(2,6,23,0.12);
    border-radius:8px;
    overflow:hidden;
    display:flex;
    flex-direction:column;
    z-index:50;
  }
  .msg-menu button{
    padding:8px 12px;border:none;background:none;text-align:left;cursor:pointer;font-weight:600;
  }
  .msg-menu button:hover{background:#f3f4f6}

  /* reply bar above input */
  #replyBar{
    display:none;
    margin:10px 14px;
    padding:10px 12px;border-radius:10px;
    background:linear-gradient(90deg,#bfdbfe,#93c5fd);
    color:var(--blue-600);
    border-left:4px solid var(--blue);
    font-weight:600;
    cursor:pointer;
    overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
  }

  /* input area fixed bottom */
  .inputArea{
    background:white;padding:12px;display:flex;gap:10px;align-items:center;border-top:1px solid #e6eefc;
  }
  .fileBtn{background:transparent;border:none;font-size:20px;cursor:pointer;color:var(--blue)}
  #messageInput{flex:1;padding:12px 14px;border-radius:24px;border:1px solid #e6eefc;font-size:15px;outline:none}
  #sendBtn{background:var(--blue);color:white;border:none;padding:10px 16px;border-radius:20px;font-weight:700;cursor:pointer}
  #sendBtn:disabled{opacity:.6;cursor:not-allowed}

  /* responsive */
  @media (max-width:600px){
    .msg-img{max-width:200px}
    .avatar{width:36px;height:36px;font-size:14px}
  }
</style>
</head>
<body>

<header>
  <div class="title">Pakhi-chat</div>
  <div class="me" id="meName"></div>
</header>

<div id="chatWrap">
  <div id="messages" aria-live="polite"></div>

  <div id="replyBar" title="‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶≤‡ßá ‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶π‡¶¨‡ßá">Replying: <span id="replySnippet"></span></div>

  <div class="inputArea">
    <button class="fileBtn" id="imgBtn" title="‡¶õ‡¶¨‡¶ø ‡¶™‡¶æ‡¶†‡¶æ‡¶ì">üì∑</button>
    <input type="file" id="imageInput" accept="image/*" style="display:none" />
    <input id="messageInput" placeholder="‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." autocomplete="off" />
    <button id="sendBtn">‡¶™‡¶æ‡¶†‡¶æ‡¶ì</button>
  </div>
</div>

<script type="module">
/* ======================
   Firebase init + imports
   ====================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getFirestore, collection, addDoc,
  query, orderBy, onSnapshot, doc, updateDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import {
  getStorage, ref as storageRef, uploadBytes, getDownloadURL
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

/* --- PUT your Firebase config here --- */
const firebaseConfig = {
  apiKey: "AIzaSyDSe4qhkuSpQCLfXWV4hMEV9iSyuTYi_nQ",
  authDomain: "chat-with-admin-1ca1a.firebaseapp.com",
  projectId: "chat-with-admin-1ca1a",
  storageBucket: "chat-with-admin-1ca1a.appspot.com",
  messagingSenderId: "604406589995",
  appId: "1:604406589995:web:8baddc0c5752386ffb586e"
};
/* ------------------------------------ */

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

/* ======================
   UI references
   ====================== */
const messagesEl = document.getElementById('messages');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const imgBtn = document.getElementById('imgBtn');
const imageInput = document.getElementById('imageInput');
const replyBar = document.getElementById('replyBar');
const replySnippet = document.getElementById('replySnippet');
const meNameEl = document.getElementById('meName');

/* ======================
   Current user (from localStorage or prompt)
   ====================== */
let chatUser = localStorage.getItem('chatUser');
if (!chatUser) {
  const name = prompt("‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßã (Chat display name):") || `User${Math.floor(Math.random()*9000)+1000}`;
  const id = 'u_' + Math.random().toString(36).slice(2,10);
  chatUser = { id, name };
  localStorage.setItem('chatUser', JSON.stringify(chatUser));
} else {
  chatUser = JSON.parse(chatUser);
}
meNameEl.textContent = chatUser.name;

/* ======================
   State
   ====================== */
let replyTo = null; // message id being replied to
let messagesCache = []; // to find reply snippet easily
let uploading = false;

/* ======================
   Helpers
   ====================== */
function formatTime(ts){
  try{
    if(!ts) return '';
    // ts might be Firestore Timestamp or ISO string; handle both
    if(ts.seconds !== undefined){
      return new Date(ts.seconds*1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    } else {
      return new Date(ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    }
  }catch(e){
    return '';
  }
}
function createAvatar(name, isSelf){
  const span = document.createElement('div');
  span.className = 'avatar ' + (isSelf ? 'self' : 'other');
  span.textContent = (name||'U').trim().charAt(0).toUpperCase();
  return span;
}

/* ======================
   Render messages list
   ====================== */
function renderMessages(list){
  messagesEl.innerHTML = '';
  list.forEach(msg=>{
    const isSelf = msg.senderId === chatUser.id;
    const wrapper = document.createElement('div');
    wrapper.className = 'message ' + (isSelf ? 'you' : 'other');
    wrapper.dataset.id = msg.id;

    // layout: avatar + body
    const avatar = createAvatar(msg.senderName || 'User', isSelf);
    const body = document.createElement('div');
    body.className = 'msgBody';

    const nameEl = document.createElement('div');
    nameEl.className = 'senderName';
    nameEl.textContent = msg.senderName || 'Unknown';

    body.appendChild(nameEl);

    // if deleted
    if(msg.deleted){
      const delEl = document.createElement('div');
      delEl.className = 'text deleted';
      delEl.textContent = 'This message was deleted';
      body.appendChild(delEl);
    } else {
      // reply snippet
      if(msg.replyTo){
        const replied = list.find(m => m.id === msg.replyTo);
        if(replied){
          const snip = document.createElement('div');
          snip.className = 'replySnippet';
          snip.textContent = `${replied.senderName}: ${replied.text ? (replied.text.length>60 ? replied.text.slice(0,57)+'...' : replied.text) : '[Image]'}`;
          body.appendChild(snip);
        }
      }
      // text
      if(msg.text){
        const t = document.createElement('div');
        t.className = 'text';
        t.textContent = msg.text;
        body.appendChild(t);
      }
      // image
      if(msg.imageUrl){
        const im = document.createElement('img');
        im.className = 'msg-img';
        im.src = msg.imageUrl;
        im.alt = 'image';
        im.onclick = (e) => {
          e.stopPropagation();
          // open in new tab (no zooming inside app)
          window.open(msg.imageUrl, '_blank');
        };
        body.appendChild(im);
      }
    }

    const timeEl = document.createElement('div');
    timeEl.className = 'time';
    timeEl.textContent = formatTime(msg.createdAt);
    body.appendChild(timeEl);

    wrapper.appendChild(avatar);
    wrapper.appendChild(body);

    // click: show popup menu
    wrapper.addEventListener('click', (e) => {
      e.stopPropagation();
      showMsgMenu(e, msg, wrapper);
    });

    messagesEl.appendChild(wrapper);
  });

  // auto scroll to bottom
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

/* ======================
   Popup menu (Reply / Delete)
   ====================== */
function showMsgMenu(e, msg, anchorEl){
  // remove existing menus
  document.querySelectorAll('.msg-menu').forEach(n=>n.remove());

  const menu = document.createElement('div');
  menu.className = 'msg-menu';

  // Reply button always
  const replyBtn = document.createElement('button');
  replyBtn.textContent = 'Reply';
  replyBtn.onclick = () => {
    replyTo = msg.id;
    const snippet = msg.text ? (msg.text.length>60 ? msg.text.slice(0,57)+'...' : msg.text) : '[Image]';
    replySnippet.textContent = snippet;
    replyBar.style.display = 'block';
    menu.remove();
    messageInput.focus();
  };
  menu.appendChild(replyBtn);

  // Delete only if own and not already deleted
  if(msg.senderId === chatUser.id && !msg.deleted){
    const delBtn = document.createElement('button');
    delBtn.textContent = 'Delete';
    delBtn.onclick = async () => {
      if(!confirm('‡¶è‡¶á ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú‡¶ü‡¶ø ‡¶°‡¶ø‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶ì?')) return;
      try{
        // mark deleted (do not remove doc) ‚Äî so other clients can see deleted notice
        const docRef = doc(db, 'messages', msg.id);
        await updateDoc(docRef, { deleted: true, text: 'This message was deleted', imageUrl: null });
      }catch(err){ console.error(err); alert('‡¶°‡¶ø‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá'); }
      menu.remove();
    };
    menu.appendChild(delBtn);
  }

  // position menu near click
  document.body.appendChild(menu);

  // compute position
  const rect = anchorEl.getBoundingClientRect();
  const menuRect = menu.getBoundingClientRect();
  let left = rect.left + rect.width/2 - menuRect.width/2;
  if(left < 8) left = 8;
  if(left + menuRect.width > window.innerWidth - 8) left = window.innerWidth - menuRect.width - 8;
  let top = rect.top + window.scrollY - menuRect.height - 8;
  if(top < window.scrollY + 8) top = rect.bottom + window.scrollY + 8; // show below if not enough space

  menu.style.left = left + 'px';
  menu.style.top = top + 'px';

  // close on outside click
  const closeFn = (ev)=>{
    if(!menu.contains(ev.target)) { menu.remove(); document.removeEventListener('click', closeFn); }
  };
  setTimeout(()=>document.addEventListener('click', closeFn), 0);
}

/* ======================
   Firestore realtime listener
   ====================== */
const messagesCol = collection(db, 'messages');
const q = query(messagesCol, orderBy('createdAt', 'asc'));

onSnapshot(q, snapshot=>{
  const docs = [];
  snapshot.forEach(snap => {
    const data = snap.data();
    docs.push({
      id: snap.id,
      senderId: data.senderId,
      senderName: data.senderName,
      text: data.text || null,
      imageUrl: data.imageUrl || null,
      createdAt: data.createdAt || data.createdAtISO || null,
      replyTo: data.replyTo || null,
      deleted: data.deleted || false
    });
  });
  messagesCache = docs;
  renderMessages(docs);
});

/* ======================
   Send message flow
   ====================== */
imgBtn.addEventListener('click', ()=> imageInput.click());
imageInput.addEventListener('change', ()=> updateSendState());

messageInput.addEventListener('input', ()=> updateSendState());

function updateSendState(){
  sendBtn.disabled = (!messageInput.value.trim() && imageInput.files.length===0) || uploading;
}

async function sendMessage(){
  const text = messageInput.value.trim();
  const file = imageInput.files[0];

  if(!text && !file) return;
  sendBtn.disabled = true;
  uploading = true;

  let imageUrl = null;
  if(file){
    try{
      const fRef = storageRef(storage, `chat_images/${Date.now()}_${file.name}`);
      await uploadBytes(fRef, file);
      imageUrl = await getDownloadURL(fRef);
    }catch(err){
      console.error(err);
      alert('‡¶á‡¶Æ‡ßá‡¶ú ‡¶Ü‡¶™‡¶≤‡ßã‡¶°‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá');
      uploading = false;
      updateSendState();
      return;
    }
  }

  try{
    await addDoc(messagesCol, {
      senderId: chatUser.id,
      senderName: chatUser.name,
      text: text || null,
      imageUrl: imageUrl || null,
      replyTo: replyTo || null,
      deleted: false,
      createdAt: serverTimestamp()
    });
    // small UI animation ‚Äî briefly pulse the input
    messageInput.value = '';
    imageInput.value = null;
    replyTo = null;
    replyBar.style.display = 'none';
  }catch(err){
    console.error(err);
    alert('‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶™‡¶æ‡¶†‡¶æ‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá');
  } finally{
    uploading = false;
    updateSendState();
  }
}

sendBtn.addEventListener('click', sendMessage);
messageInput.addEventListener('keydown', (e)=> {
  if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }
});

/* allow clicking replyBar to cancel reply */
replyBar.addEventListener('click', ()=>{
  replyTo = null;
  replyBar.style.display = 'none';
});

/* also hide any popup menus when clicking empty area */
document.addEventListener('click', ()=> {
  document.querySelectorAll('.msg-menu').forEach(n=>n.remove());
});

/* initial send state */
updateSendState();

</script>
</body>
</html>
