<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>চ্যাট এপ - লগইন</title>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

<style>
  * {
    box-sizing: border-box;
  }
  body, html {
    margin:0; padding:0; height:100%;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f9fafb;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }

  #loginPage, #chatPage {
    width: 100%;
    max-width: 480px;
    background: white;
    box-shadow: 0 2px 12px rgb(0 0 0 / 0.1);
    border-radius: 12px;
    padding: 25px 20px;
  }

  #loginPage {
    margin-top: 40px;
  }

  h2 {
    text-align: center;
    margin-bottom: 25px;
    color: #2563eb;
  }

  input[type=text], input[type=password] {
    width: 100%;
    padding: 12px 14px;
    margin-bottom: 15px;
    border: 1px solid #ccc;
    border-radius: 8px;
    font-size: 16px;
    outline: none;
  }

  button {
    width: 100%;
    background: #2563eb;
    color: white;
    padding: 12px;
    border: none;
    border-radius: 8px;
    font-weight: 700;
    font-size: 18px;
    cursor: pointer;
  }
  button:hover {
    background: #1e40af;
  }

  #errorMsg {
    color: red;
    text-align: center;
    margin-bottom: 12px;
  }

  #chatPage {
    display: none;
    height: 90vh;
    display: flex;
    flex-direction: column;
  }

  #chatHeader {
    background: #2563eb;
    color: white;
    padding: 15px 20px;
    font-weight: 700;
    font-size: 20px;
    border-radius: 12px 12px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  #logoutBtn {
    background: #f87171;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    font-weight: 700;
    cursor: pointer;
  }
  #logoutBtn:hover {
    background: #dc2626;
  }

  #messageContainer {
    flex: 1;
    overflow-y: auto;
    padding: 10px 15px;
    background: #e0e7ff;
    border-radius: 0 0 12px 12px;
    margin-bottom: 10px;
    scroll-behavior: smooth;
  }

  .message {
    background: white;
    padding: 10px 15px;
    border-radius: 12px;
    margin-bottom: 10px;
    max-width: 80%;
    word-wrap: break-word;
  }

  .myMessage {
    background: #2563eb;
    color: white;
    margin-left: auto;
  }

  .message strong {
    display: block;
    margin-bottom: 5px;
    font-weight: 700;
  }

  #inputArea {
    display: flex;
    gap: 10px;
  }

  #messageInput {
    flex: 1;
    padding: 10px 14px;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 16px;
  }

  #sendBtn, #imageUploadBtn {
    background: #2563eb;
    border: none;
    color: white;
    padding: 12px 15px;
    border-radius: 8px;
    font-weight: 700;
    cursor: pointer;
  }
  #sendBtn:hover, #imageUploadBtn:hover {
    background: #1e40af;
  }

  #imagePreview {
    margin-top: 10px;
    max-width: 100%;
    border-radius: 8px;
  }

  /* Scrollbar small & nice */
  #messageContainer::-webkit-scrollbar {
    width: 6px;
  }
  #messageContainer::-webkit-scrollbar-thumb {
    background: #a5b4fc;
    border-radius: 3px;
  }
</style>
</head>
<body>

<!-- Login Page -->
<div id="loginPage">
  <h2>চ্যাটে লগইন করো</h2>
  <div id="errorMsg"></div>
  <input type="text" id="userName" placeholder="তোমার নাম" autocomplete="off" />
  <input type="password" id="userPass" placeholder="পাসওয়ার্ড" autocomplete="off" />
  <button id="loginBtn">লগইন</button>
</div>

<!-- Chat Page -->
<div id="chatPage">
  <div id="chatHeader">
    <div>চ্যাট এপ</div>
    <button id="logoutBtn">লগআউট</button>
  </div>
  <div id="messageContainer"></div>
  <div id="inputArea">
    <input type="text" id="messageInput" placeholder="মেসেজ লিখো..." />
    <button id="sendBtn">পাঠাও</button>
    <input type="file" id="imageUpload" style="display:none" accept="image/*" />
    <button id="imageUploadBtn">ছবি</button>
  </div>
  <img id="imagePreview" style="display:none" />
</div>

<script>
  // Firebase Config - তোমার নিজস্ব
  const firebaseConfig = {
    apiKey: "AIzaSyDJ_KagqCQzTavn4SU81g9XV29k76cNLF8",
    authDomain: "pakhi-e3aad.firebaseapp.com",
    projectId: "pakhi-e3aad",
    storageBucket: "pakhi-e3aad.firebasestorage.app",
    messagingSenderId: "235336322769",
    appId: "1:235336322769:web:6400ff0350ea3c60e2fff0"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Elements
  const loginPage = document.getElementById('loginPage');
  const chatPage = document.getElementById('chatPage');
  const errorMsg = document.getElementById('errorMsg');
  const userNameInput = document.getElementById('userName');
  const userPassInput = document.getElementById('userPass');
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const messageContainer = document.getElementById('messageContainer');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const imageUpload = document.getElementById('imageUpload');
  const imageUploadBtn = document.getElementById('imageUploadBtn');
  const imagePreview = document.getElementById('imagePreview');

  let currentUser = null;

  // Auto scroll to bottom function
  function scrollToBottom() {
    messageContainer.scrollTop = messageContainer.scrollHeight;
  }

  // Show login error
  function showError(text) {
    errorMsg.textContent = text;
    setTimeout(() => { errorMsg.textContent = ''; }, 4000);
  }

  // User login function
  async function loginUser(name, pass) {
    const docRef = db.collection('users').doc(name);
    const doc = await docRef.get();
    const now = new Date();
    const loginTime = now.toLocaleString('bn-BD', { hour12: true });

    if (!doc.exists) {
      // নতুন ইউজার, পেন্ডিং এ যাবে
      await docRef.set({
        name: name,
        pass: pass,
        banned: false,
        approved: false,
        loginTime: loginTime,
      });
      alert('তোমার রিকোয়েস্ট পেয়েছি। অ্যাডমিন অনুমোদন দিলে তুমি লগইন করতে পারবে।');
      return false;
    } else {
      const data = doc.data();
      if (data.pass !== pass) {
        alert('পাসওয়ার্ড ভুল!');
        return false;
      }
      if (data.banned) {
        alert('তুমি ব্যান হয়েছো, লগইন করতে পারবে না।');
        return false;
      }
      if (!data.approved) {
        alert('অ্যাডমিন তোমার অ্যাকাউন্ট অনুমোদন করেনি। অপেক্ষা করো।');
        return false;
      }
      // অনুমোদিত ইউজার, লগইন দাও এবং loginTime আপডেট করো
      await docRef.update({ loginTime: loginTime });
      return true;
    }
  }

  // Show chat page
  function showChat() {
    loginPage.style.display = 'none';
    chatPage.style.display = 'flex';
    messageInput.focus();
  }

  // Show login page
  function showLogin() {
    chatPage.style.display = 'none';
    loginPage.style.display = 'block';
  }

  // Load chat messages realtime
  function loadMessages() {
    db.collection('messages')
      .orderBy('createdAt')
      .limit(100)
      .onSnapshot(snapshot => {
        messageContainer.innerHTML = '';
        snapshot.forEach(doc => {
          const msg = doc.data();
          const div = document.createElement('div');
          div.classList.add('message');
          if (msg.sender === currentUser) div.classList.add('myMessage');
          div.innerHTML = `<strong>${msg.sender}</strong>: `;

          if (msg.imageUrl) {
            const img = document.createElement('img');
            img.src = msg.imageUrl;
            img.style.maxWidth = '200px';
            img.style.borderRadius = '8px';
            div.appendChild(img);
          } else {
            div.innerHTML += msg.text;
          }
          messageContainer.appendChild(div);
        });
        scrollToBottom();
      });
  }

  // Send text message
  async function sendMessage() {
    const text = messageInput.value.trim();
    if (!text) return;

    await db.collection('messages').add({
      sender: currentUser,
      text: text,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    });
    messageInput.value = '';
  }

  // Send image as base64 (no firebase storage used)
  async function sendImage(base64) {
    await db.collection('messages').add({
      sender: currentUser,
      imageUrl: base64,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    });
  }

  // Handle login button click
  loginBtn.onclick = async () => {
    const name = userNameInput.value.trim();
    const pass = userPassInput.value.trim();

    if (!name || !pass) {
      showError('দয়া করে নাম ও পাসওয়ার্ড উভয় দিন।');
      return;
    }

    const loggedIn = await loginUser(name, pass);
    if (loggedIn) {
      currentUser = name;
      showChat();
      loadMessages();
    }
  };

  // Handle logout
  logoutBtn.onclick = () => {
    currentUser = null;
    showLogin();
    userNameInput.value = '';
    userPassInput.value = '';
  };

  // Send message on send button click
  sendBtn.onclick = sendMessage;

  // Enter key to send message
  messageInput.addEventListener('keyup', (e) => {
    if (e.key === 'Enter') sendMessage();
  });

  // Image upload button click to open file picker
  imageUploadBtn.onclick = () => imageUpload.click();

  // When image selected
  imageUpload.addEventListener('change', () => {
    const file = imageUpload.files[0];
    if (!file) return;

    // Show preview
    const reader = new FileReader();
    reader.onload = (e) => {
      imagePreview.src = e.target.result;
      imagePreview.style.display = 'block';
    };
    reader.readAsDataURL(file);

    // Upload/send image as base64 after preview shown
    reader.onloadend = async () => {
      await sendImage(reader.result);
      imagePreview.style.display = 'none';
      imageUpload.value = '';
    };
  });

</script>

</body>
</html>
