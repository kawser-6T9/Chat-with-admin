<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>চ্যাট অ্যাপ - ইউজার লগইন ও চ্যাট</title>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

<style>
  * {
    box-sizing: border-box;
  }
  body, html {
    margin: 0; padding: 0; height: 100%;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f3f4f6;
    display: flex; justify-content: center; align-items: center;
  }
  #loginPage, #chatPage {
    background: white;
    border-radius: 12px;
    box-shadow: 0 0 15px rgba(0,0,0,0.1);
    width: 95vw;
    max-width: 450px;
    padding: 25px 20px;
  }

  #loginPage {
    display: flex;
    flex-direction: column;
  }

  h2 {
    margin-bottom: 20px;
    text-align: center;
    color: #2563eb;
  }

  input[type="text"], input[type="password"] {
    width: 100%;
    padding: 12px 14px;
    margin-bottom: 15px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 16px;
    outline: none;
    transition: border-color 0.3s;
  }
  input[type="text"]:focus, input[type="password"]:focus {
    border-color: #2563eb;
  }

  button {
    width: 100%;
    background: #2563eb;
    color: white;
    font-weight: 700;
    font-size: 18px;
    padding: 12px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background: #1e40af;
  }

  #errorMsg {
    color: red;
    text-align: center;
    margin-bottom: 15px;
    min-height: 20px;
  }

  /* Chat page styles */
  #chatPage {
    display: none;
    height: 90vh;
    flex-direction: column;
  }
  #chatHeader {
    background: #2563eb;
    color: white;
    padding: 15px 20px;
    font-weight: 700;
    font-size: 20px;
    border-radius: 12px 12px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  #logoutBtn {
    background: #ef4444;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    font-weight: 700;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  #logoutBtn:hover {
    background: #b91c1c;
  }
  #messageContainer {
    flex: 1;
    background: #e0e7ff;
    overflow-y: auto;
    padding: 15px 20px;
    border-radius: 0 0 12px 12px;
    scroll-behavior: smooth;
  }

  .message {
    background: white;
    padding: 12px 16px;
    margin-bottom: 12px;
    max-width: 80%;
    border-radius: 12px;
    word-break: break-word;
    box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
  }
  .myMessage {
    background: #2563eb;
    color: white;
    margin-left: auto;
  }
  .message strong {
    display: block;
    margin-bottom: 6px;
  }

  #inputArea {
    display: flex;
    gap: 10px;
    padding: 10px 0;
  }
  #messageInput {
    flex: 1;
    padding: 12px 14px;
    border-radius: 8px;
    border: 1px solid #ddd;
    font-size: 16px;
    outline: none;
  }
  #messageInput:focus {
    border-color: #2563eb;
  }
  #sendBtn, #imageUploadBtn {
    background: #2563eb;
    border: none;
    padding: 12px 15px;
    border-radius: 8px;
    color: white;
    font-weight: 700;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  #sendBtn:hover, #imageUploadBtn:hover {
    background: #1e40af;
  }
  #imageUpload {
    display: none;
  }
  #imagePreview {
    max-width: 100%;
    margin-top: 10px;
    border-radius: 8px;
    display: none;
  }
</style>
</head>
<body>

<!-- Login Page -->
<div id="loginPage">
  <h2>চ্যাটে লগইন করুন</h2>
  <div id="errorMsg"></div>
  <input type="text" id="userName" placeholder="তোমার নাম" autocomplete="off" />
  <input type="password" id="userPass" placeholder="পাসওয়ার্ড" autocomplete="off" />
  <button id="loginBtn">লগইন</button>
</div>

<!-- Chat Page -->
<div id="chatPage">
  <div id="chatHeader">
    <div>চ্যাট অ্যাপ</div>
    <button id="logoutBtn">লগআউট</button>
  </div>

  <div id="messageContainer"></div>

  <div id="inputArea">
    <input type="text" id="messageInput" placeholder="মেসেজ লিখুন..." />
    <button id="sendBtn">পাঠান</button>
    <button id="imageUploadBtn">ছবি</button>
    <input type="file" id="imageUpload" accept="image/*" />
  </div>
  <img id="imagePreview" />
</div>

<script>
  // Firebase Configuration - তোমার নিজস্ব Firebase Config বসাও এখানে
  const firebaseConfig = {
    apiKey: "AIzaSyDJ_KagqCQzTavn4SU81g9XV29k76cNLF8",
    authDomain: "pakhi-e3aad.firebaseapp.com",
    projectId: "pakhi-e3aad",
    storageBucket: "pakhi-e3aad.firebasestorage.app",
    messagingSenderId: "235336322769",
    appId: "1:235336322769:web:6400ff0350ea3c60e2fff0"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Elements
  const loginPage = document.getElementById('loginPage');
  const chatPage = document.getElementById('chatPage');
  const errorMsg = document.getElementById('errorMsg');
  const userNameInput = document.getElementById('userName');
  const userPassInput = document.getElementById('userPass');
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const messageContainer = document.getElementById('messageContainer');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const imageUploadBtn = document.getElementById('imageUploadBtn');
  const imageUpload = document.getElementById('imageUpload');
  const imagePreview = document.getElementById('imagePreview');

  let currentUser = null;

  // Show error message for 4 seconds
  function showError(msg) {
    errorMsg.textContent = msg;
    setTimeout(() => errorMsg.textContent = '', 4000);
  }

  // Login function
  async function loginUser(name, pass) {
    const docRef = db.collection('users').doc(name);
    const doc = await docRef.get();
    const now = new Date();
    const loginTime = now.toLocaleString('bn-BD', { hour12: true });

    if (!doc.exists) {
      // New user registration pending approval
      await docRef.set({
        name: name,
        pass: pass,
        banned: false,
        approved: false,
        loginTime: loginTime
      });
      alert('তোমার রিকোয়েস্ট জমা পড়েছে। অ্যাডমিন অনুমোদন দিলে লগইন করতে পারবে।');
      return false;
    } else {
      const data = doc.data();
      if (data.pass !== pass) {
        alert('পাসওয়ার্ড ভুল!');
        return false;
      }
      if (data.banned) {
        alert('তুমি ব্যান হয়েছো, লগইন করতে পারবে না।');
        return false;
      }
      if (!data.approved) {
        alert('অ্যাডমিন তোমার অ্যাকাউন্ট অনুমোদন করেননি। অপেক্ষা করো।');
        return false;
      }
      // Update loginTime on each successful login
      await docRef.update({ loginTime: loginTime });
      return true;
    }
  }

  // Show chat screen
  function showChat() {
    loginPage.style.display = 'none';
    chatPage.style.display = 'flex';
    messageInput.focus();
  }
  // Show login screen
  function showLogin() {
    chatPage.style.display = 'none';
    loginPage.style.display = 'flex';
  }

  // Auto scroll chat to bottom
  function scrollToBottom() {
    messageContainer.scrollTop = messageContainer.scrollHeight;
  }

  // Load messages realtime
  function loadMessages() {
    db.collection('messages').orderBy('createdAt')
      .limit(100)
      .onSnapshot(snapshot => {
        messageContainer.innerHTML = '';
        snapshot.forEach(doc => {
          const msg = doc.data();
          const div = document.createElement('div');
          div.classList.add('message');
          if (msg.sender === currentUser) div.classList.add('myMessage');
          div.innerHTML = `<strong>${msg.sender}</strong>: `;

          if (msg.imageUrl) {
            const img = document.createElement('img');
            img.src = msg.imageUrl;
            img.style.maxWidth = '200px';
            img.style.borderRadius = '8px';
            div.appendChild(img);
          } else {
            div.innerHTML += msg.text;
          }

          messageContainer.appendChild(div);
        });
        scrollToBottom();
      });
  }

  // Send text message
  async function sendMessage() {
    const text = messageInput.value.trim();
    if (!text) return;
    await db.collection('messages').add({
      sender: currentUser,
      text: text,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    });
    messageInput.value = '';
  }

  // Send image message (base64 encoded)
  async function sendImage(base64) {
    await db.collection('messages').add({
      sender: currentUser,
      imageUrl: base64,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    });
  }

  // Event Listeners

  loginBtn.onclick = async () => {
    const name = userNameInput.value.trim();
    const pass = userPassInput.value.trim();
    if (!name || !pass) {
      showError('দয়া করে নাম ও পাসওয়ার্ড উভয় দিন।');
      return;
    }
    const loggedIn = await loginUser(name, pass);
    if (loggedIn) {
      currentUser = name;
      showChat();
      loadMessages();
    }
  };

  logoutBtn.onclick = () => {
    currentUser = null;
    showLogin();
    userNameInput.value = '';
    userPassInput.value = '';
  };

  sendBtn.onclick = sendMessage;
  messageInput.addEventListener('keyup', e => {
    if (e.key === 'Enter') sendMessage();
  });

  imageUploadBtn.onclick = () => imageUpload.click();

  imageUpload.addEventListener('change', () => {
    const file = imageUpload.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = e => {
      imagePreview.src = e.target.result;
      imagePreview.style.display = 'block';
    };
    reader.readAsDataURL(file);

    reader.onloadend = async () => {
      await sendImage(reader.result);
      imagePreview.style.display = 'none';
      imageUpload.value = '';
    };
  });

</script>

</body>
</html>
