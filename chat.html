<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶∞‡ßÅ‡¶Æ</title>
  <style>
    body, html {
      margin: 0; padding: 0; height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f2f5;
      display: flex; flex-direction: column;
    }
    header {
      background: #2563eb;
      color: white;
      padding: 15px 20px;
      font-size: 20px;
      font-weight: 700;
      text-align: center;
      user-select: none;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    #chatBox {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      background: #e5e7eb;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .message {
      max-width: 75%;
      padding: 10px 15px;
      border-radius: 20px;
      word-wrap: break-word;
      font-size: 16px;
      line-height: 1.3;
    }
    .message.self {
      align-self: flex-end;
      background: #2563eb;
      color: white;
      border-bottom-right-radius: 4px;
    }
    .message.other {
      align-self: flex-start;
      background: white;
      color: #111;
      border-bottom-left-radius: 4px;
    }
    .message img {
      max-width: 150px;
      border-radius: 12px;
      margin-top: 5px;
      cursor: pointer;
    }
    #inputArea {
      display: flex;
      padding: 10px 15px;
      background: white;
      border-top: 1px solid #ccc;
    }
    #inputArea input[type="text"] {
      flex: 1;
      padding: 10px 15px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 25px;
      outline: none;
    }
    #inputArea button, #inputArea label {
      margin-left: 10px;
      background: #2563eb;
      color: white;
      border: none;
      padding: 10px 15px;
      font-size: 18px;
      border-radius: 50%;
      cursor: pointer;
      user-select: none;
    }
    #inputArea input[type="file"] {
      display: none;
    }
    #logoutBtn {
      position: fixed;
      top: 10px;
      right: 15px;
      background: #f87171;
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      user-select: none;
      z-index: 110;
    }
  </style>
</head>
<body>

<header>‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶∞‡ßÅ‡¶Æ</header>
<button id="logoutBtn" title="‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü">‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</button>

<div id="chatBox"></div>

<div id="inputArea">
  <input type="text" id="msgInput" placeholder="‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." autocomplete="off" />
  <label for="imgUpload" title="‡¶õ‡¶¨‡¶ø ‡¶™‡¶æ‡¶†‡¶æ‡¶®">üì∑</label>
  <input type="file" id="imgUpload" accept="image/*" />
  <button id="sendBtn" title="‡¶™‡¶æ‡¶†‡¶æ‡¶®">‚û°Ô∏è</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import {
    getFirestore, collection, addDoc,
    query, orderBy, onSnapshot, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyDSe4qhkuSpQCLfXWV4hMEV9iSyuTYi_nQ",
    authDomain: "chat-with-admin-1ca1a.firebaseapp.com",
    projectId: "chat-with-admin-1ca1a",
    storageBucket: "chat-with-admin-1ca1a.appspot.com",
    messagingSenderId: "604406589995",
    appId: "1:604406589995:web:8baddc0c5752386ffb586e"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ localStorage ‡¶•‡ßá‡¶ï‡ßá
  const userName = localStorage.getItem('fdUser');
  if (!userName) {
    alert('‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø, ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßã!');
    window.location.href = 'index.html';
  }

  const chatBox = document.getElementById('chatBox');
  const msgInput = document.getElementById('msgInput');
  const sendBtn = document.getElementById('sendBtn');
  const imgUpload = document.getElementById('imgUpload');
  const logoutBtn = document.getElementById('logoutBtn');

  // ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü
  logoutBtn.onclick = () => {
    localStorage.removeItem('fdUser');
    window.location.href = 'index.html';
  };

  // ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
  async function sendMessage(text, imgBase64 = null) {
    if (!text && !imgBase64) return;

    await addDoc(collection(db, 'messages'), {
      sender: userName,
      text: text || '',
      image: imgBase64 || '',
      createdAt: serverTimestamp()
    });

    msgInput.value = '';
  }

  sendBtn.onclick = () => {
    const text = msgInput.value.trim();
    sendMessage(text);
  };

  msgInput.addEventListener('keyup', e => {
    if (e.key === 'Enter') sendBtn.click();
  });

  // ‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶π‡¶≤‡ßá base64 ‡¶è ‡¶∞‡ßÇ‡¶™‡¶æ‡¶®‡ßç‡¶§‡¶∞ ‡¶è‡¶¨‡¶Ç ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã
  imgUpload.addEventListener('change', () => {
    const file = imgUpload.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      sendMessage(null, reader.result);
    };
    reader.readAsDataURL(file);

    // ‡¶ï‡ßç‡¶≤‡¶ø‡ßü‡¶æ‡¶∞ ‡¶´‡¶æ‡¶á‡¶≤ ‡¶á‡¶®‡¶™‡ßÅ‡¶ü
    imgUpload.value = '';
  });

  // ‡¶®‡¶§‡ßÅ‡¶® ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶¶‡ßá‡¶ñ‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø realtime listener
  const q = query(collection(db, 'messages'), orderBy('createdAt'));
  onSnapshot(q, (snapshot) => {
    chatBox.innerHTML = '';
    snapshot.forEach(doc => {
      const msg = doc.data();
      const div = document.createElement('div');
      div.classList.add('message');
      div.classList.add(msg.sender === userName ? 'self' : 'other');

      let content = '';

      if(msg.text) content += `<div>${escapeHtml(msg.text)}</div>`;
      if(msg.image) content += `<img src="${msg.image}" alt="image" onclick="window.open(this.src,'_blank')" />`;

      div.innerHTML = content;

      chatBox.appendChild(div);
    });
    chatBox.scrollTop = chatBox.scrollHeight;
  });

  // ‡¶∏‡¶ø‡¶Æ‡ßç‡¶™‡¶≤ HTML ‡¶è‡¶∏‡ßç‡¶ï‡ßá‡¶™
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
</script>

</body>
</html>
