<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶™‡ßá‡¶ú</title>
<style>
  /* ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶´‡ßç‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶≤‡¶ø ‡¶ì ‡¶∏‡ßÅ‡¶®‡ßç‡¶¶‡¶∞ */
  body, html {
    margin: 0; padding: 0; height: 100%;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f0f2f5;
    display: flex; flex-direction: column;
  }
  header {
    background: #2563eb;
    color: white;
    padding: 15px 20px;
    font-weight: 700;
    font-size: 20px;
    user-select: none;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  header button {
    background: #f87171;
    border: none;
    padding: 8px 15px;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    font-weight: 700;
  }
  header button:hover {
    background: #dc2626;
  }
  #chatArea {
    flex: 1;
    overflow-y: auto;
    padding: 15px 10px;
    background: white;
    box-sizing: border-box;
  }
  .message {
    margin-bottom: 12px;
    max-width: 80%;
    padding: 10px 15px;
    border-radius: 15px;
    word-wrap: break-word;
    font-size: 16px;
  }
  .myMsg {
    background: #2563eb;
    color: white;
    margin-left: auto;
    border-bottom-right-radius: 0;
  }
  .otherMsg {
    background: #e5e7eb;
    color: #111;
    margin-right: auto;
    border-bottom-left-radius: 0;
  }
  #sendArea {
    display: flex;
    padding: 10px 15px;
    background: #fff;
    box-shadow: 0 -1px 5px rgba(0,0,0,0.1);
  }
  #msgInput {
    flex: 1;
    padding: 10px 15px;
    font-size: 16px;
    border: 1px solid #ccc;
    border-radius: 25px;
    outline: none;
  }
  #sendBtn {
    background: #2563eb;
    border: none;
    color: white;
    font-weight: 700;
    font-size: 16px;
    padding: 10px 20px;
    margin-left: 10px;
    border-radius: 25px;
    cursor: pointer;
  }
  #sendBtn:hover {
    background: #1e40af;
  }
  #imageInput {
    display: none;
  }
  label[for="imageInput"] {
    background: #2563eb;
    color: white;
    padding: 10px 15px;
    border-radius: 25px;
    cursor: pointer;
    margin-left: 10px;
    user-select: none;
  }
  /* Scrollbar customization */
  #chatArea::-webkit-scrollbar {
    width: 6px;
  }
  #chatArea::-webkit-scrollbar-thumb {
    background-color: #2563eb;
    border-radius: 3px;
  }
</style>
</head>
<body>

<header>
  <div id="userNameDisplay">‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ, ‡¶á‡¶â‡¶ú‡¶æ‡¶∞</div>
  <button id="logoutBtn">‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</button>
</header>

<div id="chatArea"></div>

<div id="sendArea">
  <input type="text" id="msgInput" placeholder="‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." autocomplete="off" />
  <label for="imageInput">üì∑</label>
  <input type="file" id="imageInput" accept="image/*" />
  <button id="sendBtn">‡¶™‡¶æ‡¶†‡¶æ‡¶ì</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
  // Firebase Config (‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ config ‡¶¨‡¶∏‡¶æ‡¶ì)
  const firebaseConfig = {
    apiKey: "AIzaSyDJ_KagqCQzTavn4SU81g9XV29k76cNLF8",
    authDomain: "pakhi-e3aad.firebaseapp.com",
    projectId: "pakhi-e3aad",
    storageBucket: "pakhi-e3aad.appspot.com",
    messagingSenderId: "235336322769",
    appId: "1:235336322769:web:6400ff0350ea3c60e2fff0"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡ßã‡¶ï‡¶æ‡¶≤‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡ßá‡¶ú ‡¶•‡ßá‡¶ï‡ßá ‡¶®‡ßá‡¶¨‡ßá
  const currentUser = localStorage.getItem('fdUser');
  if (!currentUser) {
    alert('‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶æ ‡¶®‡ßá‡¶á, ‡¶≤‡¶ó‡¶á‡¶® ‡¶™‡ßá‡¶ú‡ßá ‡¶®‡¶ø‡ßü‡ßá ‡¶Ø‡¶æ‡¶ì‡ßü‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...');
    window.location.href = 'index.html';
  }
  document.getElementById('userNameDisplay').textContent = `‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ, ${currentUser}`;

  const chatArea = document.getElementById('chatArea');
  const msgInput = document.getElementById('msgInput');
  const sendBtn = document.getElementById('sendBtn');
  const imageInput = document.getElementById('imageInput');

  // ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶ì ‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶≤‡¶ü‡¶æ‡¶á‡¶Æ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø
  function scrollToBottom() {
    chatArea.scrollTop = chatArea.scrollHeight;
  }

  db.collection('messages')
    .orderBy('timestamp')
    .onSnapshot(snapshot => {
      chatArea.innerHTML = '';
      snapshot.forEach(doc => {
        const data = doc.data();
        const msgDiv = document.createElement('div');
        msgDiv.classList.add('message');

        if (data.sender === currentUser) {
          msgDiv.classList.add('myMsg');
        } else {
          msgDiv.classList.add('otherMsg');
        }

        if (data.type === 'text') {
          msgDiv.textContent = `${data.sender}: ${data.text}`;
        } else if (data.type === 'image') {
          // ‡¶õ‡¶¨‡¶ø ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø
          const img = document.createElement('img');
          img.src = data.imageBase64;
          img.style.maxWidth = '200px';
          img.style.borderRadius = '12px';
          msgDiv.textContent = `${data.sender}: `;
          msgDiv.appendChild(img);
        }

        chatArea.appendChild(msgDiv);
      });
      scrollToBottom();
    });

  // ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
  sendBtn.onclick = async () => {
    const text = msgInput.value.trim();
    if (!text) return;

    await db.collection('messages').add({
      sender: currentUser,
      type: 'text',
      text: text,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    msgInput.value = '';
  };

  // ‡¶è‡¶®‡ßç‡¶ü‡¶æ‡¶∞ ‡¶¶‡¶ø‡ßü‡ßá ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã
  msgInput.addEventListener('keyup', e => {
    if (e.key === 'Enter') sendBtn.click();
  });

  // ‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶π‡¶≤‡ßá ‡¶¨‡ßá‡¶∏64 ‡¶è ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶¨‡ßá
  imageInput.addEventListener('change', async e => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = async function(evt) {
      const base64String = evt.target.result;
      await db.collection('messages').add({
        sender: currentUser,
        type: 'image',
        imageBase64: base64String,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      imageInput.value = '';
    };
    reader.readAsDataURL(file);
  });

  // ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶¨‡¶æ‡¶ü‡¶® ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶≤‡ßá
  document.getElementById('logoutBtn').onclick = () => {
    localStorage.removeItem('fdUser');
    window.location.href = 'index.html';
  };
</script>

</body>
</html>
