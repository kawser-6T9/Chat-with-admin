<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pakhi Chat â€” Professional</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<style>
  :root{
    --primary:#2563eb;
    --accent:#1e40af;
    --bg:#f3f6fb;
    --card:#ffffff;
    --muted:#6b7280;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  body{background:linear-gradient(180deg,#eef2f7,#f8fafc);display:flex;flex-direction:column}
  header{background:var(--primary);color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:30}
  header .brand{font-weight:700;font-size:18px}
  header .user{display:flex;align-items:center;gap:10px}
  .user .name{cursor:pointer;padding:6px 10px;border-radius:18px;background:rgba(255255255,0.06);}
  .user button{background:#ef4444;border:none;color:#fff;padding:6px 10px;border-radius:8px;font-weight:700;cursor:pointer;display:none}
  .user:hover button{display:inline-block}

  main{flex:1;overflow:auto;padding:18px;display:flex;flex-direction:column;gap:12px}
  .chat-wrap{max-width:920px;width:100%;margin:0 auto;display:flex;flex-direction:column;gap:12px}
  .day-sep{display:flex;justify-content:center;color:var(--muted);font-size:13px;margin:6px 0}

  .msg-row{display:flex;align-items:flex-end;gap:10px;max-width:78%}
  .msg-left{flex-direction:row}
  .msg-right{flex-direction:row-reverse;margin-left:auto}

  .avatar{
    width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;
    background:var(--muted);flex-shrink:0;font-size:16px;
  }
  .avatar.self{background:var(--primary)}

  .bubble{
    background:var(--card);padding:10px 12px;border-radius:14px;box-shadow:0 4px 10px rgba(2,6,23,0.06);
    word-break:break-word;max-width:70vw;position:relative;transition:transform 0.12s ease,box-shadow 0.12s;
  }
  .msg-right .bubble{background:var(--primary);color:#fff}
  .bubble img{max-width:300px;border-radius:10px;display:block;margin-bottom:8px}

  .meta{font-size:12px;color:var(--muted);margin-top:6px;display:flex;justify-content:space-between;gap:8px}
  .msg-right .meta{color:#dbeafe}

  .popup{position:absolute;top:-42px;right:6px;background:var(--primary);color:#fff;padding:6px 10px;border-radius:8px;display:flex;gap:8px;opacity:0;pointer-events:none;transform:translateY(6px);transition:all .12s}
  .popup.show{opacity:1;pointer-events:auto;transform:translateY(0)}
  .popup button{background:transparent;border:none;color:#fff;cursor:pointer;font-weight:700;padding:4px 6px;border-radius:6px}
  .deleted{font-style:italic;color:#9ca3af}

  /* reply bar & input */
  #replyBar{display:none;background:var(--primary);color:#fff;padding:10px 14px;border-radius:8px;margin:0 0 6px 0;align-items:center;justify-content:space-between;gap:12px}
  #replyBar .txt{font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

  .composer{position:sticky;bottom:0;background:linear-gradient(180deg,rgba(255,255,255,0),#fff);padding:12px 16px;display:flex;justify-content:center;z-index:40}
  .composer-inner{max-width:920px;width:100%;display:flex;gap:10px;align-items:center;background:#fff;padding:10px;border-radius:12px;box-shadow:0 -6px 20px rgba(2,6,23,0.05)}
  .file-label{cursor:pointer;font-size:20px;color:var(--primary);user-select:none}
  .text-input{flex:1;border:1px solid #e6eef8;padding:12px 14px;border-radius:999px;font-size:15px;outline:none;min-height:44px}
  .send-btn{background:var(--primary);border:none;color:#fff;border-radius:999px;width:48px;height:48px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px;box-shadow:0 6px 12px rgba(37,99,235,0.25)}
  .send-btn:disabled{opacity:.5;cursor:not-allowed;box-shadow:none}

  /* small */
  @media (max-width:600px){
    .bubble img{max-width:80vw}
    .bubble{max-width:78vw}
    .avatar{width:34px;height:34px;font-size:14px}
  }
</style>
</head>
<body>

<header>
  <div class="brand" style="color:#fff;font-weight:800">Pakhi Chat</div>
  <div class="user">
    <div class="name" id="userNameDisplay">Loading...</div>
    <button id="logoutBtn">à¦²à¦—à¦†à¦‰à¦Ÿ</button>
  </div>
</header>

<main>
  <div class="chat-wrap" id="chatWrap">
    <!-- day separators & messages will be appended here -->
  </div>
</main>

<!-- reply preview -->
<div style="max-width:920px;margin:0 auto;padding:0 16px 8px 16px">
  <div id="replyBar">
    <div class="txt" id="replyText">Replying...</div>
    <button id="cancelReply" title="à¦¬à¦¾à¦¤à¦¿à¦²">âœ–</button>
  </div>
</div>

<!-- composer -->
<div class="composer">
  <div class="composer-inner">
    <label class="file-label" for="fileInput" title="à¦›à¦¬à¦¿ à¦ªà¦¾à¦ à¦¾à¦“">ðŸ“·</label>
    <input id="fileInput" type="file" accept="image/*" style="display:none" />
    <div style="flex:1">
      <div contenteditable="true" id="messageInput" class="text-input" placeholder="à¦¬à¦¾à¦°à§à¦¤à¦¾ à¦²à¦¿à¦–à§à¦¨..." role="textbox"></div>
    </div>
    <button id="sendBtn" class="send-btn" title="à¦ªà¦¾à¦ à¦¾à¦“">âž¤</button>
  </div>
</div>

<script type="module">
/* ==========
  Professional single-file chat (Firestore + base64 images)
  Replace firebaseConfig with your project's config.
  Requires users to have set localStorage.setItem('fdUser', 'Name') before opening this page.
============*/

// Firebase imports (modular)
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, query, orderBy, onSnapshot,
  serverTimestamp, doc, updateDoc
} from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

/* ---------- REPLACE THIS WITH YOUR FIREBASE CONFIG ---------- */
const firebaseConfig = {
    apiKey: "AIzaSyDSe4qhkuSpQCLfXWV4hMEV9iSyuTYi_nQ",
    authDomain: "chat-with-admin-1ca1a.firebaseapp.com",
    projectId: "chat-with-admin-1ca1a",
    storageBucket: "chat-with-admin-1ca1a.appspot.com",
    messagingSenderId: "604406589995",
    appId: "1:604406589995:web:8baddc0c5752386ffb586e"
  };
/* ------------------------------------------------------------ */

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// DOM
const chatWrap = document.getElementById('chatWrap');
const userNameDisplay = document.getElementById('userNameDisplay');
const logoutBtn = document.getElementById('logoutBtn');
const fileInput = document.getElementById('fileInput');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const replyBar = document.getElementById('replyBar');
const replyText = document.getElementById('replyText');
const cancelReply = document.getElementById('cancelReply');

let currentUser = localStorage.getItem('fdUser') || null;
if(!currentUser){
  alert('à¦¤à§‹à¦®à¦¾à¦° à¦¨à¦¾à¦® à¦ªà¦¾à¦“à§Ÿà¦¾ à¦¯à¦¾à§Ÿà¦¨à¦¿ â€” à¦²à¦—à¦‡à¦¨ à¦ªà§‡à¦œà§‡ à¦—à¦¿à§Ÿà§‡ à¦¨à¦¾à¦® à¦¸à§‡à¦Ÿ à¦•à¦°à§‹à¥¤');
  window.location.href = 'index.html';
}
userNameDisplay.textContent = currentUser;

logoutBtn.addEventListener('click', ()=> {
  localStorage.removeItem('fdUser');
  location.href = 'index.html';
});

// replying state
let replyingTo = null; // { id, text }

// helper: convert File -> base64 (with optional resize)
function fileToBase64Resized(file, maxWidth=1000, quality=0.75){
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = e => {
      // create image to resize
      const img = new Image();
      img.onload = () => {
        let w = img.width;
        let h = img.height;
        if (w > maxWidth){
          h = Math.round(h * (maxWidth / w));
          w = maxWidth;
        }
        const canvas = document.createElement('canvas');
        canvas.width = w;
        canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img,0,0,w,h);
        // toDataURL
        const dataUrl = canvas.toDataURL('image/jpeg', quality);
        resolve(dataUrl);
      };
      img.onerror = err => reject(err);
      img.src = e.target.result;
    };
    reader.onerror = err => reject(err);
    reader.readAsDataURL(file);
  });
}

// create message element
function renderMessage(id, msg){
  const isSelf = msg.sender === currentUser;
  const row = document.createElement('div');
  row.className = 'msg-row ' + (isSelf ? 'msg-right' : 'msg-left');
  row.style.display = 'flex';
  row.style.alignItems = 'flex-end';
  row.style.gap = '10px';

  const avatar = document.createElement('div');
  avatar.className = 'avatar ' + (isSelf ? 'self':'');
  avatar.textContent = msg.sender ? msg.sender.charAt(0).toUpperCase() : '?';

  const bubble = document.createElement('div');
  bubble.className = 'bubble';
  bubble.style.position = 'relative';

  // if deleted
  if(msg.deleted){
    const del = document.createElement('div');
    del.className = 'deleted';
    del.textContent = 'This message was deleted';
    bubble.appendChild(del);
  } else {
    if(msg.replyTo && messagesCache[msg.replyTo]){
      const repMsg = messagesCache[msg.replyTo];
      const repDiv = document.createElement('div');
      repDiv.style.padding = '6px 10px';
      repDiv.style.borderLeft = '3px solid ' + (isSelf ? '#93c5fd' : '#2563eb');
      repDiv.style.background = isSelf ? 'rgba(255,255,255,0.06)' : '#f1f7ff';
      repDiv.style.borderRadius = '8px';
      repDiv.style.marginBottom = '8px';
      repDiv.style.fontSize = '13px';
      repDiv.textContent = repMsg.text ? repMsg.text.slice(0,120) : '[Image]';
      bubble.appendChild(repDiv);
    }
    if(msg.image){
      const img = document.createElement('img');
      img.src = msg.image;
      img.className = 'chat-image';
      img.alt = 'Image';
      bubble.appendChild(img);
    }
    if(msg.text){
      const p = document.createElement('div');
      p.textContent = msg.text;
      p.style.whiteSpace = 'pre-wrap';
      bubble.appendChild(p);
    }
  }

  // meta (name + time)
  const meta = document.createElement('div');
  meta.className = 'meta';
  const timeStr = msg.timestamp && msg.timestamp.toDate ? msg.timestamp.toDate().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : '';
  meta.textContent = `${msg.sender || 'Unknown'} â€¢ ${timeStr}`;
  bubble.appendChild(meta);

  // popup menu
  const popup = document.createElement('div');
  popup.className = 'popup';
  popup.style.right = '6px';

  const btnReply = document.createElement('button');
  btnReply.textContent = 'Reply';
  popup.appendChild(btnReply);
  btnReply.addEventListener('click', (e)=>{
    e.stopPropagation();
    replyingTo = { id, text: msg.text || '[Image]' };
    replyText.textContent = `Replying: ${replyingTo.text.length>80?replyingTo.text.slice(0,80)+'...':replyingTo.text}`;
    replyBar.style.display = 'flex';
    popup.classList.remove('show');
    messageInput.focus();
  });

  if(isSelf){
    const btnDel = document.createElement('button');
    btnDel.textContent = 'Delete';
    popup.appendChild(btnDel);
    btnDel.addEventListener('click', async (e)=>{
      e.stopPropagation();
      if(!confirm('à¦†à¦ªà¦¨à¦¿ à¦•à¦¿ à¦®à§‡à¦¸à§‡à¦œà¦Ÿà¦¿ à¦®à§à¦›à§‡ à¦«à§‡à¦²à¦¤à§‡ à¦šà¦¾à¦¨?')) return;
      try {
        const ref = doc(db, 'messages', id);
        await updateDoc(ref, { deleted: true, text: null, image: null, replyTo: null });
      } catch(err){
        console.error('delete error',err); alert('à¦¡à¦¿à¦²à¦¿à¦Ÿ à¦•à¦°à¦¤à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à§Ÿà§‡à¦›à§‡');
      }
      popup.classList.remove('show');
    });
  }

  bubble.appendChild(popup);

  // toggle popup on click
  bubble.addEventListener('click', (e)=>{
    e.stopPropagation();
    document.querySelectorAll('.popup.show').forEach(p=>{ if(p!==popup) p.classList.remove('show'); });
    popup.classList.toggle('show');
  });

  // click outside hides popups
  document.addEventListener('click', ()=> document.querySelectorAll('.popup.show').forEach(p=>p.classList.remove('show')));

  // assemble
  row.appendChild(avatar);
  row.appendChild(bubble);

  return row;
}

// messages cache for reply previews
const messagesCache = {};

// realtime listener
const q = query(collection(db, 'messages'), orderBy('timestamp','asc'));
onSnapshot(q, snap=>{
  chatWrap.innerHTML = '';
  // cache
  snap.forEach(docSnap => messagesCache[docSnap.id] = docSnap.data());
  // render sequentially
  snap.forEach(docSnap=>{
    const id = docSnap.id;
    const data = docSnap.data();
    const el = renderMessage(id, data);
    chatWrap.appendChild(el);
  });
  // scroll bottom
  setTimeout(()=> { window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'}); }, 50);
});

// send flow
let sending=false;
async function handleSend(){
  if(sending) return;
  const text = messageInput.innerText.trim();
  const file = fileInput.files[0];
  if(!text && !file) return;
  sending = true;
  sendBtn.disabled = true;
  let b64 = null;
  if(file){
    try{
      b64 = await fileToBase64Resized(file, 900, 0.75); // resize to width 900px
    }catch(err){ console.error(err); alert('à¦›à¦¬à¦¿ à¦°à§‚à¦ªà¦¾à¦¨à§à¦¤à¦°à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾'); sending=false; sendBtn.disabled=false; return; }
  }
  const msg = {
    sender: currentUser,
    text: text || null,
    image: b64 || null,
    timestamp: serverTimestamp(),
    replyTo: replyingTo ? replyingTo.id : null,
    deleted: false
  };
  try{
    await addDoc(collection(db,'messages'), msg);
    // reset UI
    messageInput.innerHTML = '';
    fileInput.value = '';
    replyingTo = null;
    replyBar.style.display = 'none';
    sending=false;
    sendBtn.disabled=false;
  }catch(err){
    console.error(err); alert('à¦ªà¦¾à¦ à¦¾à¦¤à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à§Ÿà§‡à¦›à§‡');
    sending=false; sendBtn.disabled=false;
  }
}

// events
sendBtn.addEventListener('click', handleSend);
messageInput.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); handleSend(); }
});
fileInput.addEventListener('change', ()=>{ /* send when file chosen? we keep manual send */ });

// cancel reply
cancelReply.addEventListener('click', ()=>{
  replyingTo = null; replyBar.style.display='none';
});

// utility: set caret to end in contenteditable after focus
function placeCaretAtEnd(el){
  el.focus();
  if(typeof window.getSelection !== "undefined" && typeof document.createRange !== "undefined"){
    const range = document.createRange();
    range.selectNodeContents(el);
    range.collapse(false);
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
  }
}

// focus behavior
messageInput.addEventListener('focus', ()=> placeCaretAtEnd(messageInput));

/* Optional: initial scroll to bottom after load */
setTimeout(()=> window.scrollTo({top:document.body.scrollHeight}),400);

</script>
</body>
</html>
