<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pakhi-chat</title>
<style>
  /* Basic Reset */
  * {
    box-sizing: border-box;
  }
  body, html {
    margin:0; padding:0; height:100%;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #f0f4f8 25%, #d9e2ec 100%);
    display: flex;
    flex-direction: column;
  }

  header {
    background: #1e40af;
    color: #e0e7ff;
    padding: 15px 20px;
    font-weight: 700;
    font-size: 24px;
    user-select:none;
    box-shadow: 0 2px 6px rgba(30, 64, 175, 0.6);
  }

  #messages {
    flex: 1;
    overflow-y: auto;
    padding: 15px 10px 10px 10px;
    background: url('https://www.transparenttextures.com/patterns/cubes.png');
    /* subtle cubes background texture */
  }

  .message {
    position: relative;
    max-width: 75%;
    margin-bottom: 12px;
    padding: 10px 15px;
    border-radius: 15px;
    word-break: break-word;
    box-shadow: 0 3px 8px rgb(0 0 0 / 0.1);
    transition: background-color 0.3s ease;
  }

  /* ‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ ‡¶ï‡¶æ‡¶≤‡¶æ‡¶∞ */
  .message.self {
    margin-left: auto;
    background: #2563eb;
    color: white;
    border-bottom-right-radius: 4px;
  }
  .message.other {
    background: #f3f4f6;
    color: #111;
    border-bottom-left-radius: 4px;
  }

  /* ‡¶®‡¶æ‡¶Æ ‡¶è‡¶¨‡¶Ç ‡¶ü‡¶æ‡¶á‡¶Æ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶Æ‡ßç‡¶™ */
  .sender-name {
    font-weight: 600;
    font-size: 12px;
    opacity: 0.7;
    margin-bottom: 5px;
  }
  .message-text {
    font-size: 16px;
  }
  .timestamp {
    font-size: 10px;
    color: #666;
    margin-top: 5px;
    text-align: right;
  }

  /* ‡¶õ‡¶¨‡¶ø */
  .message img {
    max-width: 100%;
    border-radius: 12px;
    margin-top: 6px;
    cursor: pointer;
  }

  /* ‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶¨‡¶ï‡ßç‡¶∏ */
  .reply-box {
    background: rgba(0, 0, 0, 0.08);
    border-left: 3px solid #2563eb;
    padding-left: 8px;
    font-size: 13px;
    margin-bottom: 5px;
    cursor: pointer;
    color: #2563eb;
    user-select:none;
  }

  /* ‡¶°‡¶ø‡¶≤‡ßá‡¶ü ‡¶¨‡¶æ‡¶ü‡¶® */
  .delete-btn {
    position: absolute;
    top: 6px;
    right: 8px;
    background: transparent;
    border: none;
    font-size: 18px;
    cursor: pointer;
    color: inherit;
    opacity: 0.6;
    transition: opacity 0.3s ease;
  }
  .delete-btn:hover {
    opacity: 1;
  }

  /* ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶è‡¶∞‡¶ø‡ßü‡¶æ */
  #inputArea {
    display: flex;
    padding: 10px 15px;
    background: white;
    box-shadow: 0 -1px 6px rgba(0,0,0,0.1);
    align-items: center;
  }

  #messageInput {
    flex: 1;
    padding: 12px 18px;
    border-radius: 25px;
    border: 1px solid #ddd;
    font-size: 16px;
    outline: none;
    margin-right: 10px;
  }

  #imageInput {
    display: none;
  }

  #imageLabel {
    cursor: pointer;
    font-size: 24px;
    color: #2563eb;
    margin-right: 12px;
    user-select:none;
  }

  #sendBtn {
    background: #2563eb;
    color: white;
    border: none;
    padding: 12px 18px;
    border-radius: 25px;
    font-weight: 700;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  #sendBtn:disabled {
    background: #a5b4fc;
    cursor: not-allowed;
  }
  #sendBtn:hover:not(:disabled) {
    background: #1d4ed8;
  }

  /* Scrollbar */
  #messages::-webkit-scrollbar {
    width: 8px;
  }
  #messages::-webkit-scrollbar-thumb {
    background-color: rgba(37, 99, 235, 0.5);
    border-radius: 10px;
  }

  /* Responsive */
  @media (max-width: 600px) {
    header {
      font-size: 20px;
    }
    #messageInput {
      font-size: 14px;
    }
    #sendBtn {
      padding: 10px 14px;
    }
  }
</style>
</head>
<body>

<header>Pakhi-chat</header>

<div id="messages"></div>

<div id="inputArea">
  <input type="text" id="messageInput" placeholder="‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." autocomplete="off" />
  <label for="imageInput" id="imageLabel" title="‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßã">üì∑</label>
  <input type="file" id="imageInput" accept="image/*" />
  <button id="sendBtn" disabled>‡¶™‡¶æ‡¶†‡¶æ‡¶ì</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import {
    getFirestore, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyDSe4qhkuSpQCLfXWV4hMEV9iSyuTYi_nQ",
    authDomain: "chat-with-admin-1ca1a.firebaseapp.com",
    projectId: "chat-with-admin-1ca1a",
    storageBucket: "chat-with-admin-1ca1a.appspot.com",
    messagingSenderId: "604406589995",
    appId: "1:604406589995:web:8baddc0c5752386ffb586e"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // User info - LocalStorage ‡¶•‡ßá‡¶ï‡ßá ‡¶®‡¶æ‡¶ì
  const userId = localStorage.getItem('userId') || `user_${Math.floor(Math.random()*100000)}`;
  const userName = localStorage.getItem('userName') || 'Anonymous';

  localStorage.setItem('userId', userId);
  localStorage.setItem('userName', userName);

  const messagesDiv = document.getElementById('messages');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const imageInput = document.getElementById('imageInput');

  let isUploading = false;
  let replyTo = null;  // reply ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú

  // Send button Enable/Disable
  function updateSendBtn() {
    sendBtn.disabled = !messageInput.value.trim() && !imageInput.files.length && !isUploading;
  }

  messageInput.addEventListener('input', updateSendBtn);
  imageInput.addEventListener('change', updateSendBtn);

  // Real-time ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã
  const messagesCol = collection(db, 'messages');
  const q = query(messagesCol, orderBy('createdAt', 'asc'));

  onSnapshot(q, (snapshot) => {
    messagesDiv.innerHTML = '';
    snapshot.forEach(docSnap => {
      const msg = docSnap.data();
      const id = docSnap.id;

      // ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú div
      const msgDiv = document.createElement('div');
      msgDiv.classList.add('message');
      msgDiv.classList.add(msg.senderId === userId ? 'self' : 'other');

      // sender name
      const senderDiv = document.createElement('div');
      senderDiv.classList.add('sender-name');
      senderDiv.textContent = msg.senderName || 'Unknown';
      msgDiv.appendChild(senderDiv);

      // reply box ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã
      if(msg.replyTo){
        const replyDiv = document.createElement('div');
        replyDiv.classList.add('reply-box');
        replyDiv.textContent = `‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á: ${msg.replyTo.text || (msg.replyTo.imageUrl ? '‡¶õ‡¶¨‡¶ø' : '')}`;
        replyDiv.title = "‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®";
        replyDiv.onclick = () => alert(`‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú:\n\n${msg.replyTo.text || '[‡¶õ‡¶¨‡¶ø]'}`);
        msgDiv.appendChild(replyDiv);
      }

      // ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü
      if(msg.text){
        const textDiv = document.createElement('div');
        textDiv.classList.add('message-text');
        textDiv.textContent = msg.text;
        msgDiv.appendChild(textDiv);
      }

      // ‡¶õ‡¶¨‡¶ø ‡¶•‡¶æ‡¶ï‡¶≤‡ßá
      if(msg.imageUrl){
        const img = document.createElement('img');
        img.src = msg.imageUrl;
        img.alt = "Image";
        img.onclick = () => window.open(msg.imageUrl, '_blank');
        msgDiv.appendChild(img);
      }

      // ‡¶ü‡¶æ‡¶á‡¶Æ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶Æ‡ßç‡¶™
      const timeDiv = document.createElement('div');
      timeDiv.classList.add('timestamp');
      timeDiv.textContent = msg.createdAt ? new Date(msg.createdAt.seconds * 1000).toLocaleTimeString('bn-BD', {hour:'2-digit', minute:'2-digit'}) : '';
      msgDiv.appendChild(timeDiv);

      // ‡¶°‡¶ø‡¶≤‡ßá‡¶ü ‡¶¨‡¶æ‡¶ü‡¶®, ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶®‡¶ø‡¶ú‡ßá‡¶∞ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú‡ßá
      if(msg.senderId === userId){
        const delBtn = document.createElement('button');
        delBtn.classList.add('delete-btn');
        delBtn.title = '‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶°‡¶ø‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡ßã';
        delBtn.innerHTML = 'üóëÔ∏è';
        delBtn.onclick = async () => {
          if(confirm('‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶ï‡¶ø ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶ì?')){
            await deleteDoc(doc(db, 'messages', id));
          }
        };
        msgDiv.appendChild(delBtn);
      }

      // ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶≤‡ßá reply set ‡¶π‡¶¨‡ßá
      msgDiv.onclick = () => {
        if(msg.senderId !== userId) return; // ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶®‡¶ø‡¶ú‡ßá‡¶∞ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú‡ßá ‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶¶‡¶ø‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá ‡¶®‡¶æ (‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®‡¶Æ‡¶§ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡ßã)
        replyTo = { id, text: msg.text, imageUrl: msg.imageUrl };
        messageInput.focus();
        messageInput.placeholder = '‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®... (‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶§‡ßá ESC ‡¶ö‡¶æ‡¶™‡ßÅ‡¶®)';
      };

      messagesDiv.appendChild(msgDiv);
    });

    // ‡¶®‡¶ø‡¶ö‡ßá ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶≤
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    updateSendBtn();
  });

  // ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
  async function sendMessage(){
    if(isUploading) return;

    const text = messageInput.value.trim();
    if(!text && !imageInput.files.length) return;

    sendBtn.disabled = true;

    let imageUrl = null;
    if(imageInput.files.length){
      isUploading = true;
      const file = imageInput.files[0];
      const storageRef = ref(storage, `chatImages/${Date.now()}_${file.name}`);
      try{
        await uploadBytes(storageRef, file);
        imageUrl = await getDownloadURL(storageRef);
      }catch(err){
        alert('‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá');
        console.error(err);
      }
      isUploading = false;
    }

    await addDoc(messagesCol, {
      text: text || null,
      imageUrl: imageUrl || null,
      senderId: userId,
      senderName: userName,
      replyTo: replyTo || null,
      createdAt: serverTimestamp()
    });

    // ‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶ï‡ßç‡¶≤‡¶ø‡ßü‡¶æ‡¶∞
    replyTo = null;
    messageInput.value = '';
    messageInput.placeholder = '‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®...';
    imageInput.value = null;
    updateSendBtn();
  }

  sendBtn.addEventListener('click', sendMessage);

  messageInput.addEventListener('keypress', e => {
    if(e.key === 'Enter' && !e.shiftKey){
      e.preventDefault();
      sendMessage();
    }
    else if(e.key === 'Escape'){
      // ESC ‡¶™‡ßç‡¶∞‡ßá‡¶∏ ‡¶ï‡¶∞‡¶≤‡ßá ‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤
      replyTo = null;
      messageInput.placeholder = '‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®...';
    }
  });
</script>

</body>
</html>
