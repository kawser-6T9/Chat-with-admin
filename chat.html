<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fresh Pakhi Chat</title>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Roboto&display=swap');
  * {
    box-sizing: border-box;
  }
  body, html {
    margin: 0; padding: 0; height: 100vh;
    font-family: 'Roboto', sans-serif;
    background: #f0f4f8 url('https://www.transparenttextures.com/patterns/cubes.png') repeat;
    display: flex;
    flex-direction: column;
  }

  header {
    background: #2563eb;
    color: white;
    padding: 15px 20px;
    font-weight: 700;
    font-size: 22px;
    display: flex;
    justify-content: flex-end;
    align-items: center;
    position: sticky;
    top: 0;
    user-select: none;
    z-index: 50;
  }

  #userNameDisplay {
    cursor: pointer;
    position: relative;
    padding: 6px 12px;
    border-radius: 20px;
    transition: background-color 0.3s ease;
  }
  #userNameDisplay:hover {
    background-color: rgba(255 255 255 / 0.2);
  }
  #logoutBtn {
    position: absolute;
    top: 110%;
    right: 0;
    background: #f87171;
    border-radius: 10px;
    color: white;
    font-weight: 700;
    padding: 8px 15px;
    font-size: 14px;
    cursor: pointer;
    user-select:none;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease, transform 0.3s ease;
    transform: translateY(-10px);
    white-space: nowrap;
  }
  #logoutBtn.show {
    opacity: 1;
    pointer-events: auto;
    transform: translateY(0);
  }

  main {
    flex: 1;
    overflow-y: auto;
    padding: 15px 20px;
    scroll-behavior: smooth;
    background: white;
    border-top: 1px solid #ddd;
    border-bottom: 1px solid #ddd;
  }

  .message-wrapper {
    margin-bottom: 14px;
    display: flex;
    align-items: flex-end;
    max-width: 75%;
    position: relative;
    animation: fadeIn 0.4s ease forwards;
  }
  @keyframes fadeIn {
    from {opacity:0; transform: translateY(15px);}
    to {opacity:1; transform: translateY(0);}
  }

  .message-left {
    flex-direction: row;
  }
  .message-right {
    flex-direction: row-reverse;
    margin-left: auto;
  }

  .profile-circle {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    background: #2563eb;
    color: white;
    font-weight: 700;
    font-size: 18px;
    line-height: 38px;
    text-align: center;
    user-select: none;
    margin: 0 12px;
    flex-shrink: 0;
  }

  .message-box {
    background: white;
    padding: 12px 18px;
    border-radius: 16px;
    font-size: 15px;
    line-height: 1.3;
    max-width: 320px;
    word-wrap: break-word;
    box-shadow: 0 3px 8px rgba(0,0,0,0.12);
    cursor: pointer;
    position: relative;
    user-select:none;
  }
  .message-right .message-box {
    background: #2563eb;
    color: white;
    box-shadow: 0 3px 10px rgba(37,99,235,0.7);
  }

  .message-meta {
    font-size: 11px;
    margin-top: 4px;
    user-select:none;
  }
  .message-meta-left {
    color: #475569;
  }
  .message-meta-right {
    color: #a5b4fc;
    text-align: right;
  }

  .popup-menu {
    position: absolute;
    top: -40px;
    right: 0;
    background: #2563eb;
    color: white;
    font-size: 14px;
    border-radius: 8px;
    padding: 6px 10px;
    display: flex;
    gap: 14px;
    user-select:none;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    z-index: 200;
  }
  .popup-menu.show {
    opacity: 1;
    pointer-events: auto;
  }
  .popup-menu button {
    background: transparent;
    border: none;
    color: white;
    font-weight: 700;
    cursor: pointer;
    padding: 3px 6px;
    border-radius: 4px;
    transition: background-color 0.2s ease;
  }
  .popup-menu button:hover {
    background-color: #1e40af;
  }

  #replyBar {
    background: #2563eb;
    color: white;
    padding: 10px 18px;
    font-size: 14px;
    display: none;
    align-items: center;
    justify-content: space-between;
    user-select:none;
  }
  #replyBar span {
    font-weight: 600;
    max-width: 80%;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  #replyBar button {
    background: transparent;
    border: none;
    color: white;
    font-weight: 700;
    cursor: pointer;
    font-size: 20px;
    line-height: 18px;
  }

  #inputArea {
    display: flex;
    padding: 14px 18px;
    background: white;
    align-items: center;
    gap: 12px;
    box-shadow: 0 -1px 8px rgba(0,0,0,0.12);
    position: sticky;
    bottom: 0;
    z-index: 30;
  }
  #messageInput {
    flex: 1;
    border: 1.7px solid #ccc;
    border-radius: 28px;
    padding: 12px 22px;
    font-size: 17px;
    outline: none;
    transition: border-color 0.3s ease;
  }
  #messageInput:focus {
    border-color: #2563eb;
  }
  #sendBtn {
    background: #2563eb;
    border: none;
    border-radius: 50%;
    width: 46px;
    height: 46px;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: background-color 0.3s ease;
  }
  #sendBtn:hover {
    background-color: #1d4ed8;
  }
  #sendBtn svg {
    fill: white;
    width: 26px;
    height: 26px;
  }

  #imageUpload {
    display: none;
  }
  #imageLabel {
    cursor: pointer;
    font-size: 24px;
    color: #2563eb;
    user-select:none;
  }

  img.chat-image {
    max-width: 260px;
    border-radius: 16px;
    margin-top: 6px;
    display: block;
  }
</style>
</head>
<body>

<header>
  <div id="userNameDisplay"></div>
</header>

<main id="chatArea"></main>

<!-- ‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶¨‡¶æ‡¶∞ -->
<div id="replyBar">
  <span id="replyText"></span>
  <button id="cancelReplyBtn" title="‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®">&times;</button>
</div>

<!-- ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶è‡¶∞‡¶ø‡ßü‡¶æ -->
<div id="inputArea">
  <label for="imageUpload" id="imageLabel" title="‡¶õ‡¶¨‡¶ø ‡¶™‡¶æ‡¶†‡¶æ‡¶ì üì∑">üì∑</label>
  <input type="file" accept="image/*" id="imageUpload" />
  <input type="text" id="messageInput" placeholder="‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." autocomplete="off" />
  <button id="sendBtn" title="‡¶™‡¶æ‡¶†‡¶æ‡¶ì">
    <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
  </button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
  import {
    getFirestore, collection, query, orderBy, onSnapshot,
    addDoc, serverTimestamp, doc, deleteDoc, updateDoc
  } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

  // ‡¶´‡¶æ‡ßü‡¶æ‡¶∞‡¶¨‡ßá‡¶∏ ‡¶ï‡¶®‡¶´‡¶ø‡¶ó (‡¶®‡¶ø‡¶ú‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶ú‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶∞ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®)
  const firebaseConfig = {
    apiKey: "AIzaSyDSe4qhkuSpQCLfXWV4hMEV9iSyuTYi_nQ",
    authDomain: "chat-with-admin-1ca1a.firebaseapp.com",
    projectId: "chat-with-admin-1ca1a",
    storageBucket: "chat-with-admin-1ca1a.appspot.com",
    messagingSenderId: "604406589995",
    appId: "1:604406589995:web:8baddc0c5752386ffb586e"
  };

  // Firebase ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡ßü‡¶æ‡¶≤‡¶æ‡¶á‡¶ú
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ‡¶≤‡ßã‡¶ï‡¶æ‡¶≤‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡ßá‡¶ú ‡¶•‡ßá‡¶ï‡ßá ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ
  let currentUser = localStorage.getItem('fdUser');
  if (!currentUser) {
    alert('‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ó‡¶á‡¶® ‡¶™‡ßá‡¶ú ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
    window.location.href = 'index.html'; // ‡¶≤‡¶ó‡¶á‡¶® ‡¶™‡ßá‡¶ú‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã
  }

  // DOM ‡¶è‡¶≤‡¶ø‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡¶∏
  const userNameDisplay = document.getElementById('userNameDisplay');
  const chatArea = document.getElementById('chatArea');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const imageUpload = document.getElementById('imageUpload');
  const replyBar = document.getElementById('replyBar');
  const replyText = document.getElementById('replyText');
  const cancelReplyBtn = document.getElementById('cancelReplyBtn');

  // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶ì ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶¨‡¶æ‡¶ü‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ
  userNameDisplay.textContent = currentUser;

  // ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶¨‡¶æ‡¶ü‡¶® ‡¶§‡ßà‡¶∞‡¶ø
  const logoutBtn = document.createElement('button');
  logoutBtn.id = 'logoutBtn';
  logoutBtn.textContent = '‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü';
  userNameDisplay.appendChild(logoutBtn);

  // ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï
  logoutBtn.addEventListener('click', () => {
    localStorage.removeItem('fdUser');
    window.location.href = 'index.html'; // ‡¶≤‡¶ó‡¶á‡¶® ‡¶™‡ßá‡¶ú
  });

  // ‡¶≤‡ßã‡¶ó‡¶Ü‡¶â‡¶ü ‡¶¨‡¶æ‡¶ü‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã/‡¶≤‡ßÅ‡¶ï‡¶æ‡¶®‡ßã ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ ‡¶π‡ßã‡¶≠‡¶æ‡¶∞ ‡¶è
  userNameDisplay.addEventListener('mouseenter', () => {
    logoutBtn.classList.add('show');
  });
  userNameDisplay.addEventListener('mouseleave', () => {
    logoutBtn.classList.remove('show');
  });

  // ‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶Ü‡¶á‡¶°‡¶ø ‡¶è‡¶¨‡¶Ç ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü
  let replyingTo = null;

  // ‡¶´‡¶æ‡¶á‡¶≤ ‡¶•‡ßá‡¶ï‡ßá base64 ‡¶¨‡¶æ‡¶®‡¶æ‡¶®‡ßã ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = e => resolve(e.target.result);
      reader.onerror = err => reject(err);
      reader.readAsDataURL(file);
    });
  }

  // ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶∏‡ßá‡¶®‡ßç‡¶° ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
  async function sendMessage() {
    const text = messageInput.value.trim();
    const file = imageUpload.files[0];

    if (!text && !file) {
      alert('‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ ‡¶¨‡¶æ ‡¶õ‡¶¨‡¶ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®');
      return;
    }

    let imageBase64 = null;
    if (file) {
      try {
        imageBase64 = await fileToBase64(file);
      } catch (e) {
        alert('‡¶õ‡¶¨‡¶ø ‡¶∞‡ßÇ‡¶™‡¶æ‡¶®‡ßç‡¶§‡¶∞‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá');
        return;
      }
    }

    const messageData = {
      sender: currentUser,
      timestamp: serverTimestamp(),
      text: text || null,
      image: imageBase64 || null,
      replyTo: replyingTo ? replyingTo.id : null,
      deleted: false
    };

    try {
      await addDoc(collection(db, "messages"), messageData);
    } catch (err) {
      alert('‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶™‡¶æ‡¶†‡¶æ‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!');
      console.error(err);
    }

    // ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶ï‡ßç‡¶≤‡¶ø‡ßü‡¶æ‡¶∞ ‡¶ì ‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶¨‡¶æ‡¶∞ ‡¶π‡¶æ‡¶á‡¶°
    messageInput.value = '';
    imageUpload.value = '';
    clearReply();
  }

  sendBtn.addEventListener('click', sendMessage);
  messageInput.addEventListener('keypress', e => {
    if (e.key === 'Enter') sendMessage();
  });

  cancelReplyBtn.addEventListener('click', clearReply);

  function clearReply() {
    replyingTo = null;
    replyBar.style.display = 'none';
    replyText.textContent = '';
  }

  // ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
  function renderMessage(msg, msgId) {
    const isCurrentUser = msg.sender === currentUser;

    const wrapper = document.createElement('div');
    wrapper.classList.add('message-wrapper', isCurrentUser ? 'message-right' : 'message-left');
    wrapper.dataset.msgId = msgId;

    // ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡ßü‡¶æ‡¶≤
    const profileCircle = document.createElement('div');
    profileCircle.className = 'profile-circle';
    profileCircle.textContent = msg.sender.charAt(0).toUpperCase();

    // ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶¨‡¶ï‡ßç‡¶∏
    const msgBox = document.createElement('div');
    msgBox.className = 'message-box';

    // ‡¶Ø‡¶¶‡¶ø ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶•‡¶æ‡¶ï‡ßá
    if (msg.deleted) {
      msgBox.textContent = 'This message was deleted';
      msgBox.style.fontStyle = 'italic';
      msgBox.style.color = isCurrentUser ? '#d1d5db' : '#6b7280';
    } else {
      // ‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶Ö‡¶Ç‡¶∂ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶¨
      if (msg.replyTo && messagesCache[msg.replyTo]) {
        const repliedMsg = messagesCache[msg.replyTo];
        const replyDiv = document.createElement('div');
        replyDiv.style.backgroundColor = isCurrentUser ? 'rgba(255 255 255 / 0.25)' : '#e5e7eb';
        replyDiv.style.padding = '6px 10px';
        replyDiv.style.marginBottom = '8px';
        replyDiv.style.borderLeft = `4px solid ${isCurrentUser ? '#93c5fd' : '#2563eb'}`;
        replyDiv.style.fontSize = '13px';
        replyDiv.style.color = isCurrentUser ? 'white' : 'black';
        replyDiv.style.borderRadius = '8px';
        replyDiv.style.userSelect = 'none';
        replyDiv.textContent = (repliedMsg.text) ? repliedMsg.text : '[‡¶õ‡¶¨‡¶ø]';
        msgBox.appendChild(replyDiv);
      }

      // ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶Ø‡ßã‡¶ó
      if (msg.text) {
        const textNode = document.createTextNode(msg.text);
        msgBox.appendChild(textNode);
      }

      // ‡¶á‡¶Æ‡ßá‡¶ú ‡¶Ø‡ßã‡¶ó
      if (msg.image) {
        const img = document.createElement('img');
        img.className = 'chat-image';
        img.src = msg.image;
        msgBox.appendChild(document.createElement('br'));
        msgBox.appendChild(img);
      }
    }

    // ‡¶Æ‡ßá‡¶ü‡¶æ ‡¶°‡¶ø‡¶≠ (‡¶®‡¶æ‡¶Æ + ‡¶∏‡¶Æ‡ßü)
    const meta = document.createElement('div');
    meta.className = 'message-meta ' + (isCurrentUser ? 'message-meta-right' : 'message-meta-left');

    let timeString = '';
    if (msg.timestamp && msg.timestamp.toDate) {
      timeString = msg.timestamp.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
    meta.textContent = `${msg.sender} ‚Ä¢ ${timeString}`;

    // ‡¶™‡¶™‡¶Ü‡¶™ ‡¶Æ‡ßá‡¶®‡ßÅ (Reply/Delete)
    const popupMenu = document.createElement('div');
    popupMenu.className = 'popup-menu';
    popupMenu.innerHTML = `
      <button class="reply-btn">Reply</button>
      ${isCurrentUser ? '<button class="delete-btn">Delete</button>' : ''}
    `;
    msgBox.appendChild(popupMenu);

    // ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶¨‡¶ï‡ßç‡¶∏‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶≤‡ßá ‡¶™‡¶™‡¶Ü‡¶™ ‡¶Æ‡ßá‡¶®‡ßÅ ‡¶ü‡¶ó‡¶≤ ‡¶π‡¶¨‡ßá
    msgBox.addEventListener('click', e => {
      e.stopPropagation();
      closeAllPopupsExcept(popupMenu);
      popupMenu.classList.toggle('show');
    });

    // Reply button click
    popupMenu.querySelector('.reply-btn').addEventListener('click', e => {
      e.stopPropagation();
      replyToMessage(msg, msgId);
      popupMenu.classList.remove('show');
    });

    // Delete button click (‡¶®‡¶ø‡¶ú‡ßá‡¶∞ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú)
    if (isCurrentUser) {
      popupMenu.querySelector('.delete-btn').addEventListener('click', async e => {
        e.stopPropagation();
        const confirmDelete = confirm('‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?');
        if (confirmDelete) {
          await deleteMessage(msgId);
        }
        popupMenu.classList.remove('show');
      });
    }

    // ‡¶ï‡ßç‡¶≤‡ßã‡¶ú ‡¶Æ‡ßá‡¶®‡ßÅ ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶Ü‡¶â‡¶ü‡¶∏‡¶æ‡¶á‡¶°
    document.addEventListener('click', () => {
      popupMenu.classList.remove('show');
    });

    wrapper.appendChild(profileCircle);
    wrapper.appendChild(msgBox);
    wrapper.appendChild(meta);

    return wrapper;
  }

  // ‡¶∏‡¶ï‡¶≤ ‡¶™‡¶™‡¶Ü‡¶™ ‡¶Æ‡ßá‡¶®‡ßÅ ‡¶ï‡ßç‡¶≤‡ßã‡¶ú ‡¶ï‡¶∞‡¶æ
  function closeAllPopupsExcept(exceptElem) {
    document.querySelectorAll('.popup-menu.show').forEach(menu => {
      if (menu !== exceptElem) {
        menu.classList.remove('show');
      }
    });
  }

  // ‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
  function replyToMessage(msg, msgId) {
    replyingTo = { id: msgId, text: msg.text || '[‡¶õ‡¶¨‡¶ø]' };
    replyText.textContent = `Replying to: ${replyingTo.text}`;
    replyBar.style.display = 'flex';
    messageInput.focus();
  }

  // ‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶ï‡ßç‡¶≤‡¶ø‡ßü‡¶æ‡¶∞
  function clearReply() {
    replyingTo = null;
    replyBar.style.display = 'none';
    replyText.textContent = '';
  }

  cancelReplyBtn.addEventListener('click', clearReply);

  // ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü (Firestore ‡¶è deleted: true ‡¶ï‡¶∞‡ßá)
  async function deleteMessage(id) {
    try {
      const messageRef = doc(db, 'messages', id);
      await updateDoc(messageRef, { deleted: true, text: null, image: null, replyTo: null });
    } catch (e) {
      alert('‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!');
      console.error(e);
    }
  }

  // ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ - ‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø
  const messagesCache = {};

  // ‡¶∞‡¶ø‡ßü‡ßá‡¶≤‡¶ü‡¶æ‡¶á‡¶Æ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶≤‡ßã‡¶°
  const q = query(collection(db, "messages"), orderBy("timestamp"));

  onSnapshot(q, (snapshot) => {
    chatArea.innerHTML = '';
    snapshot.forEach(docSnap => {
      const msg = docSnap.data();
      const id = docSnap.id;
      messagesCache[id] = msg;
    });
    // ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶ø
    snapshot.forEach(docSnap => {
      const msg = docSnap.data();
      const id = docSnap.id;
      chatArea.appendChild(renderMessage(msg, id));
    });
    chatArea.scrollTop = chatArea.scrollHeight;
  });
</script>

</body>
</html>
