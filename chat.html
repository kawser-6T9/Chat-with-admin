<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶∞‡ßÅ‡¶Æ</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin:0; display:flex; flex-direction:column; height:100vh;
    }
    header {
      background:#2563eb; color:#fff; padding:15px;
      font-weight:bold; display:flex; justify-content:space-between;
      align-items:center;
    }
    #logoutBtn {
      background:#f87171; border:none; color:#fff;
      padding:8px 15px; border-radius:5px; cursor:pointer;
    }
    #messages {
      flex:1; overflow-y:auto; padding:15px;
      background:#f9f9f9;
    }
    .message {
      background:#fff; padding:10px; margin-bottom:10px;
      border-radius:8px; box-shadow:0 0 3px rgba(0,0,0,0.1);
      position: relative;
      max-width: 80%;
    }
    .message.you {
      margin-left:auto; background:#dbeafe;
    }
    .sender {
      font-weight:bold; margin-bottom:5px;
      font-size:14px; color:#2563eb;
    }
    .text {
      font-size:16px;
      white-space: pre-wrap;
    }
    .replyBox {
      font-size: 13px;
      color: #555;
      background: #f0f0f0;
      padding: 5px 8px;
      border-left: 3px solid #2563eb;
      margin-bottom: 5px;
      border-radius: 5px;
    }
    .message img {
      max-width: 200px;
      border-radius: 8px;
      margin-top: 5px;
      cursor: pointer;
    }
    .actions {
      position: absolute;
      top: 5px;
      right: 10px;
      font-size: 14px;
      display: flex;
      gap: 10px;
    }
    .actions button {
      background: transparent;
      border: none;
      cursor: pointer;
      color: #888;
    }
    .actions button:hover {
      color: #2563eb;
    }
    #inputBox {
      display:flex; padding:10px; background:#eee;
      gap: 5px;
    }
    #messageInput {
      flex:1; padding:10px; border-radius:5px; border:1px solid #ccc;
      font-size:16px;
    }
    #sendBtn, #imageBtn, #replyCancelBtn {
      background:#2563eb; color:#fff; border:none;
      padding:10px 15px; border-radius:5px; cursor:pointer;
      font-weight:bold;
    }
    #replyCancelBtn {
      background:#f87171;
    }
    #replyInfo {
      background:#e0e7ff; padding:5px 10px; border-radius:5px;
      margin-bottom:5px; font-size:14px;
      display:none;
      position:relative;
    }
    #replyInfo button {
      position:absolute;
      top:2px; right:5px;
      background: transparent; border:none;
      font-weight:bold; cursor:pointer; color:#2563eb;
      font-size:16px;
    }
  </style>
</head>
<body>

<header>
  ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶∞‡ßÅ‡¶Æ - <span id="userName"></span>
  <button id="logoutBtn">‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</button>
</header>

<div id="messages"></div>

<div id="replyInfo">
  ‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶ï‡¶∞‡¶õ‡¶ø: <span id="replyText"></span>
  <button id="replyCancelBtn">√ó</button>
</div>

<div id="inputBox">
  <input type="text" id="messageInput" placeholder="‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." />
  <input type="file" id="imageInput" accept="image/*" style="display:none" />
  <button id="imageBtn">üñºÔ∏è</button>
  <button id="sendBtn">‡¶™‡¶æ‡¶†‡¶æ‡¶ì</button>
</div>

<script type="module">
  import { db, storage } from './firebase-config.js';
  import {
    collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, deleteDoc, getDoc, updateDoc
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
  import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

  const userId = localStorage.getItem('userId');
  const userName = localStorage.getItem('userName');

  if (!userId || !userName) {
    alert('‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
    window.location.href = 'index.html';
  }

  document.getElementById('userName').textContent = userName;

  const messagesDiv = document.getElementById('messages');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const imageBtn = document.getElementById('imageBtn');
  const imageInput = document.getElementById('imageInput');
  const logoutBtn = document.getElementById('logoutBtn');

  const replyInfo = document.getElementById('replyInfo');
  const replyTextSpan = document.getElementById('replyText');
  const replyCancelBtn = document.getElementById('replyCancelBtn');

  let replyTo = null;

  // ‡¶≤‡ßã‡¶ó‡¶Ü‡¶â‡¶ü
  logoutBtn.onclick = () => {
    localStorage.clear();
    window.location.href = 'index.html';
  };

  // ‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶ï‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏‡ßá‡¶≤
  replyCancelBtn.onclick = () => {
    replyTo = null;
    replyInfo.style.display = 'none';
  };

  // ‡¶á‡¶Æ‡ßá‡¶ú ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶≤‡ßá ‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá
  imageBtn.onclick = () => {
    imageInput.click();
  };

  // ‡¶á‡¶Æ‡ßá‡¶ú ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶π‡¶≤‡ßá ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßã
  imageInput.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const storageRef = ref(storage, `chatImages/${Date.now()}_${file.name}`);
    try {
      const snapshot = await uploadBytes(storageRef, file);
      const url = await getDownloadURL(snapshot.ref);
      sendMessage('', url);  // ‡¶´‡¶æ‡¶Å‡¶ï‡¶æ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶ì ‡¶á‡¶Æ‡ßá‡¶ú URL ‡¶∏‡¶π ‡¶™‡¶æ‡¶†‡¶æ‡¶¨‡ßá
      imageInput.value = '';
    } catch (err) {
      alert('‡¶á‡¶Æ‡ßá‡¶ú ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§');
      console.error(err);
    }
  };

  // ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
  async function sendMessage(text, imageUrl = '') {
    if (!text && !imageUrl) return;

    try {
      await addDoc(collection(db, 'messages'), {
        sender: userId,
        senderName: userName,
        text,
        imageUrl,
        timestamp: serverTimestamp(),
        replyTo,
      });
      messageInput.value = '';
      replyTo = null;
      replyInfo.style.display = 'none';
    } catch (err) {
      alert('‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶™‡¶æ‡¶†‡¶æ‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§');
      console.error(err);
    }
  }

  sendBtn.onclick = () => {
    sendMessage(messageInput.value.trim());
  };

  messageInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage(messageInput.value.trim());
    }
  });

  // ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶≤‡ßã‡¶° ‡¶ì ‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶≤‡¶ü‡¶æ‡¶á‡¶Æ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
  const messagesQuery = query(collection(db, 'messages'), orderBy('timestamp', 'asc'));
  onSnapshot(messagesQuery, (snapshot) => {
    messagesDiv.innerHTML = '';
    snapshot.forEach(doc => {
      const msg = doc.data();
      const id = doc.id;

      // ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú div ‡¶§‡ßà‡¶∞‡¶ø
      const msgDiv = document.createElement('div');
      msgDiv.classList.add('message');
      if (msg.sender === userId) msgDiv.classList.add('you');

      // sender name
      const senderDiv = document.createElement('div');
      senderDiv.classList.add('sender');
      senderDiv.textContent = msg.senderName || 'Unknown';
      msgDiv.appendChild(senderDiv);

      // reply info
      if (msg.replyTo) {
        const replyDocRef = doc(db, 'messages', msg.replyTo);
        getDoc(replyDocRef).then(replyDocSnap => {
          if (replyDocSnap.exists()) {
            const replyData = replyDocSnap.data();
            const replyBox = document.createElement('div');
            replyBox.classList.add('replyBox');
            replyBox.textContent = `‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á: ${replyData.text ? replyData.text.slice(0,50) : '[‡¶õ‡¶¨‡¶ø]'}`;
            msgDiv.insertBefore(replyBox, senderDiv.nextSibling);
          }
        });
      }

      // message text
      const textDiv = document.createElement('div');
      textDiv.classList.add('text');
      textDiv.textContent = msg.text;
      msgDiv.appendChild(textDiv);

      // image show
      if (msg.imageUrl) {
        const img = document.createElement('img');
        img.src = msg.imageUrl;
        img.alt = "Image";
        msgDiv.appendChild(img);
      }

      // actions: reply, delete (delete only if sender)
      const actionsDiv = document.createElement('div');
      actionsDiv.classList.add('actions');

      const replyBtn = document.createElement('button');
      replyBtn.textContent = '‚Ü©Ô∏è';
      replyBtn.title = '‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶ï‡¶∞‡ßã';
      replyBtn.onclick = () => {
        replyTo = id;
        replyInfo.style.display = 'block';
        replyTextSpan.textContent = msg.text || '[‡¶õ‡¶¨‡¶ø]';
        messageInput.focus();
      };
      actionsDiv.appendChild(replyBtn);

      if (msg.sender === userId) {
        const delBtn = document.createElement('button');
        delBtn.textContent = 'üóëÔ∏è';
        delBtn.title = '‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡ßã';
        delBtn.onclick = async () => {
          if (confirm('‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶ï‡¶ø ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶ì?')) {
            try {
              await deleteDoc(doc(db, 'messages', id));
              alert('‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
            } catch (err) {
              alert('‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
              console.error(err);
            }
          }
        };
        actionsDiv.appendChild(delBtn);
      }

      msgDiv.appendChild(actionsDiv);
      messagesDiv.appendChild(msgDiv);
    });

    // ‡¶Ö‡¶ü‡ßã ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶≤ ‡¶ü‡ßÅ ‡¶®‡¶ø‡¶ö‡ßá
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
</script>

</body>
</html>
